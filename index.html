<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Grupo A Cobijo</title>
  <meta name="description" content="App de experiencia del cliente: eventos, horarios y accesos del Grupo A Cobijo.">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0ea5e9">
  <link rel="icon" href="assets/icons/icon-192.png">
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    :root{
      --bg:#fff; --card:#f4f9ff; --line:#dce7f5; --tint:#eaf4ff;
      --text:#0a1a2a; --accent:#0077cc; --ink:#064e89; --muted:#687588;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:#fff;color:var(--text)}
    .wrap{max-width:900px;margin:0 auto;padding:22px}
    header{display:flex;align-items:center;gap:14px;margin:6px 0 16px;flex-wrap:wrap}
    .logo-img{height:72px;width:auto;object-fit:contain;cursor:pointer}
    h1{margin:0;font-size:1.5rem}
    .tag{color:var(--muted);font-size:.9rem}
    .spacer{flex:1}
    .pill{border:1px solid var(--line);background:var(--tint);border-radius:999px;padding:4px 10px;font-size:.8rem;color:var(--ink)}
    .btn{appearance:none;border:1px solid var(--line);background:rgba(0,119,204,.08);color:var(--ink);padding:10px 12px;border-radius:12px;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;font-weight:600;gap:6px}
    .btn.small{padding:6px 10px;font-weight:600}
    .btn.on{background:var(--accent); color:#fff;}
    .row{display:flex;flex-wrap:wrap;gap:8px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin:12px 0 26px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    section h2{font-size:1.2rem;margin:18px 0 8px;color:var(--ink)}

    .event-card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
    .event-thumb{width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:10px;margin-bottom:8px;border:1px solid var(--line)}
    .event-title{font-weight:700}
    .event-meta{font-size:.85rem;color:var(--muted)}
    .event-desc{font-size:.9rem;margin-top:6px}

    .map{width:100%;aspect-ratio:16/10;border-radius:12px;overflow:hidden;border:1px solid var(--line)}
    .map iframe{width:100%;height:100%;border:0}

    /* Modal genérico */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal{width:min(92vw,900px);background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 28px rgba(0,0,0,.2);
      max-height:88vh; overflow:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain;}
    .close{background:transparent;border:none;color:var(--muted);font-weight:700;float:right}
    body.modal-open{overflow:hidden}

    /* Admin */
    .admin-btn{display:none;margin:8px 0 0}
    .admin-on .admin-btn{display:inline-flex}
    .table{width:100%;border-collapse:collapse;font-size:.9rem}
    .table th,.table td{border:1px solid var(--line);padding:6px 8px;text-align:left;vertical-align:top}
    .table th{background:var(--tint)}
    .input,.select,.textarea{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .muted{color:var(--muted);font-size:.85rem}
  </style>
</head>
<body>
<div class="wrap">

  <header>
    <!-- Toca 5 veces para activar admin -->
    <img src="assets/logo.png" alt="Grupo A Cobijo" class="logo-img" id="logoTap">
    <div>
      <h1 id="t-app">Grupo A Cobijo</h1>
      <div class="tag" id="t-subtitle">Tu estancia con nosotros · Oyambre · Ramales · Ruiloba</div>
    </div>
    <div class="spacer"></div>
    <button class="btn small" id="langBtn">🌐 ES</button>
    <span class="pill" id="t-pwa">PWA • Offline</span>
  </header>

  <!-- Modal idiomas -->
  <div class="backdrop" id="langModal">
    <div class="modal">
      <button id="closeLang" class="close" aria-label="Cerrar">✕</button>
      <h3 id="langTitle">Selecciona idioma</h3>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px">
        <button class="btn lang-option" data-lang="es">🇪🇸 Español</button>
        <button class="btn lang-option" data-lang="en">🇬🇧 English</button>
        <button class="btn lang-option" data-lang="fr">🇫🇷 Français</button>
        <button class="btn lang-option" data-lang="de">🇩🇪 Deutsch</button>
        <button class="btn lang-option" data-lang="nl">🇳🇱 Nederlands</button>
      </div>
    </div>
  </div>

  <!-- EVENTOS -->
  <section>
    <h2 id="t-events-title">Eventos Grupo A Cobijo</h2>

    <!-- Filtros -->
    <div class="row" id="eventFilterRow" style="margin-bottom:8px">
      <button class="btn small filter-btn on" data-filter="all" id="f-all">Todos</button>
      <button class="btn small filter-btn" data-filter="today" id="f-today">Hoy</button>
      <button class="btn small filter-btn" data-filter="tomorrow" id="f-tomorrow">Mañana</button>
      <button class="btn small filter-btn" data-filter="week" id="f-week">Esta semana</button>
    </div>

    <div id="events" class="grid"></div>
  </section>

  <!-- HORARIOS -->
  <section class="card">
    <h2 id="t-schedules-title">Horarios</h2>
    <p class="hint" id="t-schedules-hint">Recepción, restaurante, piscina... elige tu camping.</p>
    <div class="row">
      <button class="btn" data-sched="oyambre" id="btn-oy">Oyambre</button>
      <button class="btn" data-sched="ramales" id="btn-ra">Ramales</button>
      <button class="btn" data-sched="ruiloba" id="btn-he">Ruiloba</button>
      <button class="btn" data-sched="cardeo" id="btn-ca">El Cardeo</button>
    </div>
  </section>

  <!-- Modal horarios -->
  <div class="backdrop" id="schedModal">
    <div class="modal">
      <button class="close" id="closeSched" aria-label="Cerrar">✕</button>
      <h3 id="schedTitle">Horarios</h3>
      <div id="schedBody" class="card" style="margin-top:8px"></div>
      <p class="muted" id="schedNote">Info orientativa. Pregunta en recepción para cambios de temporada.</p>
    </div>
  </div>

  <!-- CAMPINGS -->
  <section style="margin-top:24px">
    <h2 id="t-campings-title">Nuestros campings</h2>
    <div class="grid">

      <!-- Oyambre -->
      <article class="card">
        <h3 id="t-oy-title">Camping Caravaning Playa de Oyambre</h3>
        <p class="hint" id="t-oy-hint">Todos los servicios · Frente al mar</p>
        <div class="row">
          <a class="btn" data-i18n-web href="https://www.oyambre.com" target="_blank" rel="noopener">Web</a>
          <a class="btn" data-i18n-call href="tel:+34942711461">Llamar</a>
          <a class="btn" data-i18n-directions href="https://maps.google.com/?q=Camping+Caravaning+Playa+de+Oyambre" target="_blank" rel="noopener">Cómo llegar</a>
          <a class="btn" data-i18n-whatsapp href="https://wa.me/34675696212" target="_blank" rel="noopener">WhatsApp</a>
        </div>
        <div class="map"><iframe src="https://www.google.com/maps?q=Camping+Caravaning+Playa+de+Oyambre&output=embed" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></div>
      </article>

      <!-- Ramales -->
      <article class="card">
        <h3 id="t-ra-title">Camping Ramales</h3>
        <p class="hint" id="t-ra-hint">Cuevas · Montaña · Actividades</p>
        <div class="row">
          <a class="btn" data-i18n-web href="https://www.campingramales.com" target="_blank" rel="noopener">Web</a>
          <a class="btn" data-i18n-call href="tel:+34654463133">Llamar</a>
          <a class="btn" data-i18n-directions href="https://maps.google.com/?q=Camping+Ramales" target="_blank" rel="noopener">Cómo llegar</a>
          <a class="btn" data-i18n-whatsapp href="https://wa.me/34654463133" target="_blank" rel="noopener">WhatsApp</a>
        </div>
        <div class="map"><iframe src="https://www.google.com/maps?q=Camping+Ramales&output=embed" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></div>
      </article>

      <!-- Ruiloba -->
      <article class="card">
        <h3 id="t-he-title">Camping El Helguero (Ruiloba)</h3>
        <p class="hint" id="t-he-hint">Naturaleza · Familiar · Mascotas</p>
        <div class="row">
          <a class="btn" data-i18n-web href="https://www.campingelhelguero.com" target="_blank" rel="noopener">Web</a>
          <a class="btn" data-i18n-call href="tel:+34942722124">Llamar</a>
          <a class="btn" data-i18n-directions href="https://maps.google.com/?q=Camping+El+Helguero" target="_blank" rel="noopener">Cómo llegar</a>
          <a class="btn" data-i18n-whatsapp href="https://wa.me/34652806564" target="_blank" rel="noopener">WhatsApp</a>
        </div>
        <div class="map"><iframe src="https://www.google.com/maps?q=Camping+El+Helguero&output=embed" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></div>
      </article>

    </div>
  </section>

  <!-- OTROS ALOJAMIENTOS -->
  <section style="margin-top:24px">
    <h2 id="t-others-title">Otros alojamientos del grupo</h2>
    <div class="grid">
      <article class="card">
        <h3 id="t-ca-title">Apartamentos / Taberna El Cardeo</h3>
        <p class="hint" id="t-ca-hint">Apartamentos + Taberna</p>
        <div class="row">
          <a class="btn" data-i18n-web href="https://www.elcardeo.es" target="_blank" rel="noopener">Web</a>
          <a class="btn" data-i18n-call href="tel:+34664686158">Llamar</a>
          <a class="btn" data-i18n-directions href="https://maps.app.goo.gl/XCzaYGDDLk2CQ8VK6" target="_blank" rel="noopener">Cómo llegar</a>
          <a class="btn" data-i18n-whatsapp href="https://wa.me/34664686158" target="_blank" rel="noopener">WhatsApp</a>
        </div>
        <div class="map"><iframe src="https://www.google.com/maps?q=Apartamentos+El+Cardeo&output=embed" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></div>
      </article>
    </div>
  </section>

  <!-- ADMIN: botón visible solo en modo admin -->
  <div>
    <button id="openAdmin" class="btn admin-btn">➕ Añadir / editar eventos</button>
  </div>

  <!-- INSTALAR APP -->
  <section class="card">
    <h2 id="t-install-title">Instálame como app</h2>
    <p id="t-install-hint" class="hint">Android: ⋮ → Instalar app. iOS: Compartir → Añadir a pantalla de inicio.</p>
    <button id="installBtn" class="btn" style="display:none">Instalar ahora</button>
    <p id="pwaStatus" class="hint"></p>
  </section>

  <footer>
    © <span id="year"></span> Grupo A Cobijo · <span class="ok" id="t-offline">Funciona sin conexión</span> ●
  </footer>
</div>

<!-- MODAL ADMIN -->
<div class="backdrop" id="adminModal" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
  <div class="modal">
    <button class="close" id="closeAdmin" aria-label="Cerrar">✕</button>
    <h3 id="adminTitle">Gestión de eventos</h3>

    <div class="card" style="margin-top:8px">
      <h4 style="margin:0 0 8px">Añadir evento</h4>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px">
        <div>
          <label>Título (ES)</label>
          <input id="evTitle" class="input" placeholder="Ej: Concierto acústico">
        </div>
        <div>
          <label>Fecha y hora</label>
          <input id="evDate" type="datetime-local" class="input">
        </div>
        <div>
          <label>Alojamiento</label>
          <select id="evPlace" class="select">
            <option value="oyambre">Oyambre</option>
            <option value="ramales">Ramales</option>
            <option value="ruiloba">Ruiloba</option>
            <option value="cardeo">El Cardeo</option>
          </select>
        </div>
        <div>
          <label>Lugar (ES)</label>
          <input id="evLugar" class="input" placeholder="Ej: Camping Ramales">
        </div>
        <div>
          <label>Imagen (URL)</label>
          <input id="evImg" class="input" placeholder="https://...">
        </div>
        <div style="grid-column:1 / -1">
          <label>Descripción (ES)</label>
          <textarea id="evDesc" class="textarea" rows="3" placeholder="Ej: Música en directo."></textarea>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="addEventBtn" class="btn">Agregar a la lista</button>
        <button id="exportEventsBtn" class="btn">Descargar events.json</button>
        <button id="exportZipBtn" class="btn">Descargar copia (ZIP)</button>
        <label class="btn" for="importFile" style="cursor:pointer">Importar JSON</label>
        <input id="importFile" type="file" accept="application/json" style="display:none">
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4 style="margin:0 0 8px">Eventos actuales</h4>
      <div style="overflow:auto">
        <table class="table" id="eventsTable">
          <thead>
            <tr><th>ID</th><th>Fecha</th><th>Alojamiento</th><th>Título / Descripción / Imagen</th><th>Acciones</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="hint">Pulsa “Descargar events.json” y súbelo a GitHub, o usa la subida directa más abajo.</p>
    </div>

    <!-- CONFIG GITHUB -->
    <div class="card" style="margin-top:12px">
      <h4>Config GitHub</h4>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px">
        <div>
          <label>Repositorio (owner/repo)</label>
          <input id="ghRepo" class="input" placeholder="owner/repo">
        </div>
        <div>
          <label>Branch</label>
          <input id="ghBranch" class="input" placeholder="main" value="main">
        </div>
        <div style="grid-column:1/-1">
          <label>Token (solo se guarda en este dispositivo)</label>
          <input id="ghToken" class="input" placeholder="github_pat_..." autocomplete="off">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="saveGhCfg" class="btn">Guardar configuración</button>
        <button id="pushEventsBtn" class="btn">💾 Guardar en GitHub (events.json)</button>
      </div>
      <p class="hint">El token no se sube a ningún servidor; queda en tu dispositivo (localStorage).</p>
    </div>
  </div>
</div>

<!-- JSZip para ZIP backup -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
document.getElementById("year").textContent = new Date().getFullYear();

/* ───────────────── I18N ───────────────── */
const I18N = {
  es:{app:"Grupo A Cobijo",subtitle:"Tu estancia con nosotros · Oyambre · Ramales · Ruiloba",
      pwa:"PWA • Offline",langTitle:"Selecciona idioma",
      eventsTitle:"Eventos Grupo A Cobijo",schedulesTitle:"Horarios",schedulesHint:"Recepción, restaurante, piscina... elige tu camping.",
      campingsTitle:"Nuestros campings",othersTitle:"Otros alojamientos del grupo",
      installTitle:"Instálame como app",installHint:"Android: ⋮ → Instalar app. iOS: Compartir → Añadir a pantalla de inicio.",offline:"Funciona sin conexión",
      web:"Web",call:"Llamar",directions:"Cómo llegar",whatsapp:"WhatsApp",
      oyTitle:"Camping Caravaning Playa de Oyambre",oyHint:"Todos los servicios · Frente al mar",
      raTitle:"Camping Ramales",raHint:"Cuevas · Montaña · Actividades",
      heTitle:"Camping El Helguero (Ruiloba)",heHint:"Naturaleza · Familiar · Mascotas",
      caTitle:"Apartamentos / Taberna El Cardeo",caHint:"Apartamentos + Taberna",
      schedNote:"Info orientativa. Pregunta en recepción para cambios de temporada.",
      fAll:"Todos", fToday:"Hoy", fTomorrow:"Mañana", fWeek:"Esta semana"},
  en:{app:"Grupo A Cobijo",subtitle:"Your stay with us · Oyambre · Ramales · Ruiloba",
      pwa:"PWA • Offline",langTitle:"Choose language",
      eventsTitle:"Grupo A Cobijo Events",schedulesTitle:"Schedules",schedulesHint:"Reception, restaurant, pool... choose your site.",
      campingsTitle:"Our campsites",othersTitle:"Other group accommodations",
      installTitle:"Install me as an app",installHint:"Android: ⋮ → Install app. iOS: Share → Add to Home Screen.",offline:"Works offline",
      web:"Website",call:"Call",directions:"Directions",whatsapp:"WhatsApp",
      oyTitle:"Camping Caravaning Playa de Oyambre",oyHint:"All services · By the sea",
      raTitle:"Camping Ramales",raHint:"Caves · Mountains · Activities",
      heTitle:"Camping El Helguero (Ruiloba)",heHint:"Nature · Family · Pets",
      caTitle:"El Cardeo Apartments / Tavern",caHint:"Apartments + Tavern",
      schedNote:"Indicative info. Check reception for seasonal changes.",
      fAll:"All", fToday:"Today", fTomorrow:"Tomorrow", fWeek:"This week"},
  fr:{app:"Groupe A Cobijo",subtitle:"Votre séjour avec nous · Oyambre · Ramales · Ruiloba",
      pwa:"PWA • Hors ligne",langTitle:"Choisir la langue",
      eventsTitle:"Événements Groupe A Cobijo",schedulesTitle:"Horaires",schedulesHint:"Réception, restaurant, piscine... choisissez votre camping.",
      campingsTitle:"Nos campings",othersTitle:"Autres hébergements du groupe",
      installTitle:"Installe-moi comme application",installHint:"Android : ⋮ → Installer l’app. iOS : Partager → Sur l’écran d’accueil.",offline:"Fonctionne hors ligne",
      web:"Site web",call:"Appeler",directions:"Itinéraire",whatsapp:"WhatsApp",
      oyTitle:"Camping Caravaning Playa de Oyambre",oyHint:"Tous services · Bord de mer",
      raTitle:"Camping Ramales",raHint:"Grottes · Montagne · Activités",
      heTitle:"Camping El Helguero (Ruiloba)",heHint:"Nature · Famille · Animaux",
      caTitle:"Appartements / Taverne El Cardeo",caHint:"Appartements + Taverne",
      schedNote:"Infos indicatives. Vérifiez à la réception les changements saisonniers.",
      fAll:"Tous", fToday:"Aujourd’hui", fTomorrow:"Demain", fWeek:"Cette semaine"},
  de:{app:"Gruppe A Cobijo",subtitle:"Ihr Aufenthalt bei uns · Oyambre · Ramales · Ruiloba",
      pwa:"PWA • Offline",langTitle:"Sprache wählen",
      eventsTitle:"Veranstaltungen Grupo A Cobijo",schedulesTitle:"Öffnungszeiten",schedulesHint:"Rezeption, Restaurant, Pool... wähle deinen Platz.",
      campingsTitle:"Unsere Campingplätze",othersTitle:"Weitere Unterkünfte der Gruppe",
      installTitle:"Als App installieren",installHint:"Android: ⋮ → App installieren. iOS: Teilen → Zum Home-Bildschirm.",offline:"Funktioniert offline",
      web:"Webseite",call:"Anrufen",directions:"Anfahrt",whatsapp:"WhatsApp",
      oyTitle:"Camping Caravaning Playa de Oyambre",oyHint:"Alle Services · Am Meer",
      raTitle:"Camping Ramales",raHint:"Höhlen · Berge · Aktivitäten",
      heTitle:"Camping El Helguero (Ruiloba)",heHint:"Natur · Familie · Haustiere",
      caTitle:"El Cardeo Apartments / Taverne",caHint:"Apartments + Taverne",
      schedNote:"Unverbindliche Infos. Änderungen saisonabhängig an der Rezeption.",
      fAll:"Alle", fToday:"Heute", fTomorrow:"Morgen", fWeek:"Diese Woche"},
  nl:{app:"Groep A Cobijo",subtitle:"Je verblijf bij ons · Oyambre · Ramales · Ruiloba",
      pwa:"PWA • Offline",langTitle:"Taal kiezen",
      eventsTitle:"Evenementen Grupo A Cobijo",schedulesTitle:"Openingstijden",schedulesHint:"Receptie, restaurant, zwembad... kies je camping.",
      campingsTitle:"Onze campings",othersTitle:"Overige accommodaties van de groep",
      installTitle:"Installeer als app",installHint:"Android: ⋮ → App installeren. iOS: Delen → Zet op beginscherm.",offline:"Werkt offline",
      web:"Website",call:"Bellen",directions:"Route",whatsapp:"WhatsApp",
      oyTitle:"Camping Caravaning Playa de Oyambre",oyHint:"Alle faciliteiten · Aan zee",
      raTitle:"Camping Ramales",raHint:"Grotten · Bergen · Activiteiten",
      heTitle:"Camping El Helguero (Ruiloba)",heHint:"Natuur · Familie · Huisdieren",
      caTitle:"El Cardeo Apartments / Taverne",caHint:"Apartments + Taverne",
      schedNote:"Indicatieve info. Informeer bij de receptie voor seizoenswijzigingen.",
      fAll:"Alle", fToday:"Vandaag", fTomorrow:"Morgen", fWeek:"Deze week"}
};

function detectLang(){const s=localStorage.getItem("lang");if(s)return s;const n=(navigator.language||"es").slice(0,2).toLowerCase();return ["es","en","fr","de","nl"].includes(n)?n:"es";}
function setLangBadge(l){const m={es:"ES",en:"EN",fr:"FR",de:"DE",nl:"NL"};document.getElementById("langBtn").textContent=`🌐 ${m[l]}`;}
function t(id,val){const el=document.getElementById(id);if(el)el.textContent=val;}
function applyLang(lang){
  const T=I18N[lang]; if(!T) return;
  t("t-app",T.app); t("t-subtitle",T.subtitle); t("t-pwa",T.pwa);
  t("t-events-title",T.eventsTitle); t("t-schedules-title",T.schedulesTitle); t("t-schedules-hint",T.schedulesHint);
  t("t-campings-title",T.campingsTitle); t("t-others-title",T.othersTitle);
  t("t-install-title",T.installTitle); t("t-install-hint",T.installHint);
  t("t-oy-title",T.oyTitle); t("t-oy-hint",T.oyHint);
  t("t-ra-title",T.raTitle); t("t-ra-hint",T.raHint);
  t("t-he-title",T.heTitle); t("t-he-hint",T.heHint);
  t("t-ca-title",T.caTitle); t("t-ca-hint",T.caHint);
  t("langTitle",T.langTitle); t("schedNote",T.schedNote);
  // Filtros
  t("f-all",T.fAll); t("f-today",T.fToday); t("f-tomorrow",T.fTomorrow); t("f-week",T.fWeek);
  document.querySelectorAll("[data-i18n-web]").forEach(e=>e.textContent=T.web);
  document.querySelectorAll("[data-i18n-call]").forEach(e=>e.textContent=T.call);
  document.querySelectorAll("[data-i18n-directions]").forEach(e=>e.textContent=T.directions);
  document.querySelectorAll("[data-i18n-whatsapp]").forEach(e=>e.textContent=T.whatsapp);
  localStorage.setItem("lang",lang); setLangBadge(lang); loadEvents();
}

let LANG = detectLang(); setLangBadge(LANG); applyLang(LANG);

/* Idiomas modal */
const langModal=document.getElementById("langModal");
document.getElementById("langBtn").onclick=()=>langModal.style.display="flex";
document.getElementById("closeLang").onclick=()=>langModal.style.display="none";
langModal.onclick=(e)=>{if(e.target===langModal)langModal.style.display="none";}
document.querySelectorAll(".lang-option").forEach(b=>b.onclick=()=>{LANG=b.dataset.lang;applyLang(LANG);});

/* ───────────── EVENTOS ───────────── */
const PLACE_LINK={oyambre:"https://maps.google.com/?q=Camping+Caravaning+Playa+de+Oyambre",ramales:"https://maps.google.com/?q=Camping+Ramales",ruiloba:"https://maps.google.com/?q=Camping+El+Helguero",cardeo:"https://maps.app.goo.gl/XCzaYGDDLk2CQ8VK6"};
const PLACE_LABEL={oyambre:"Oyambre",ramales:"Ramales",ruiloba:"Ruiloba",cardeo:"El Cardeo"};
const WHATSAPP={oyambre:"34675696212",ramales:"34654463133",ruiloba:"34652806564",cardeo:"34664686158"};

let EVENTS=[]; let CURRENT_FILTER='all';

function i18nField(v){return typeof v==="string"?v:(v?.[LANG]||v?.es||"");}

function categoryFor(dateStr){
  const d=new Date(dateStr);
  const now=new Date();
  const startToday=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  const startTomorrow=new Date(startToday); startTomorrow.setDate(startToday.getDate()+1);
  const endOfWeek=new Date(startToday); endOfWeek.setDate(startToday.getDate() + (7 - startToday.getDay()));
  if(d>=startToday && d<startTomorrow) return 'today';
  if(d>=startTomorrow && d<new Date(startTomorrow.getFullYear(),startTomorrow.getMonth(),startTomorrow.getDate()+1)) return 'tomorrow';
  if(d>=startToday && d<endOfWeek) return 'week';
  return 'all';
}

function waLinkFor(camping,message){
  const n=WHATSAPP[(camping||'').toLowerCase()];
  if(!n) return null;
  const txt=encodeURIComponent(message||'');
  return `https://wa.me/${n}${txt?`?text=${txt}`:''}`;
}

function renderEvent(ev){
  const title=i18nField(ev.titulo)||"(sin título)";
  const desc=i18nField(ev.descripcion)||"";
  const place=i18nField(ev.lugar)||PLACE_LABEL[(ev.camping||"").toLowerCase()]||"";
  const when=new Intl.DateTimeFormat(LANG,{weekday:'long',day:'numeric',month:'long',hour:'2-digit',minute:'2-digit'}).format(new Date(ev.fecha));
  const maps=PLACE_LINK[(ev.camping||"").toLowerCase()]||(place?`https://www.google.com/maps?q=${encodeURIComponent(place)}`:"#");
  const imgSrc = ev.imagen || ev.image || "";
  const waMsg = `Hola, tengo una consulta sobre el evento “${title}” en ${place}.`;
  const wa = waLinkFor(ev.camping, waMsg);

  return `
    <div class="event-card">
      ${imgSrc ? `<img class="event-thumb" src="${imgSrc}" alt="${title}" loading="lazy" onerror="this.style.display='none'">` : ""}
      <div class="event-title">${title}</div>
      <div class="event-meta">${when} · ${place}</div>
      <div class="event-desc">${desc}</div>
      <div class="row" style="margin-top:6px">
        ${wa ? `<a class="btn" href="${wa}" target="_blank" rel="noopener" data-i18n-whatsapp>WhatsApp</a>` : ""}
        <a class="btn" href="${maps}" target="_blank" rel="noopener" data-i18n-directions>Cómo llegar</a>
      </div>
    </div>
  `;
}

function renderEvents(){
  const list=document.getElementById('events');
  if(!EVENTS.length){list.innerHTML='<p class="muted">Sin eventos por ahora.</p>';return;}
  const filtered = EVENTS.filter(ev=>{
    if(CURRENT_FILTER==='all') return true;
    return categoryFor(ev.fecha)===CURRENT_FILTER;
  }).sort((a,b)=> new Date(a.fecha)-new Date(b.fecha));
  list.innerHTML = filtered.map(renderEvent).join('') || '<p class="muted">Sin eventos por ahora.</p>';
}

async function loadEvents(){
  try{
    const r=await fetch(`./events.json?v=${Date.now()}`,{cache:'no-cache'});
    const data=await r.json();
    EVENTS = Array.isArray(data)?data:[];
    renderEvents();
  }catch(e){
    EVENTS=[]; renderEvents();
  }
}

/* Filtros UI */
document.querySelectorAll('.filter-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('on'));
    btn.classList.add('on');
    CURRENT_FILTER = btn.dataset.filter || 'all';
    renderEvents();
  });
});
loadEvents();

/* ───────────── HORARIOS ───────────── */
const SCHEDULES={
  oyambre:{
    es:`<b>Recepción</b>: 9:00–21:00<br><b>Restaurante</b>: 13:00–16:00 / 20:00–23:30<br><b>Piscina (verano)</b>: 10:00–20:00`,
    en:`<b>Reception</b>: 9:00–21:00<br><b>Restaurant</b>: 13:00–16:00 / 20:00–23:30<br><b>Pool (summer)</b>: 10:00–20:00`,
    fr:`<b>Réception</b>: 9:00–21:00<br><b>Restaurant</b>: 13:00–16:00 / 20:00–23:30<br><b>Piscine (été)</b>: 10:00–20:00`,
    de:`<b>Rezeption</b>: 9:00–21:00<br><b>Restaurant</b>: 13:00–16:00 / 20:00–23:30<br><b>Pool (Sommer)</b>: 10:00–20:00`,
    nl:`<b>Receptie</b>: 9:00–21:00<br><b>Restaurant</b>: 13:00–16:00 / 20:00–23:30<br><b>Zwembad (zomer)</b>: 10:00–20:00`
  },
  ramales:{
    es:`<b>Recepción</b>: 9:00–21:00<br><b>Bar</b>: 9:00–23:30<br><b>Piscina (verano)</b>: 11:00–20:00`,
    en:`<b>Reception</b>: 9:00–21:00<br><b>Bar</b>: 9:00–23:30<br><b>Pool (summer)</b>: 11:00–20:00`,
    fr:`<b>Réception</b>: 9:00–21:00<br><b>Bar</b>: 9:00–23:30<br><b>Piscine (été)</b>: 11:00–20:00`,
    de:`<b>Rezeption</b>: 9:00–21:00<br><b>Bar</b>: 9:00–23:30<br><b>Pool (Sommer)</b>: 11:00–20:00`,
    nl:`<b>Receptie</b>: 9:00–21:00<br><b>Bar</b>: 9:00–23:30<br><b>Zwembad (zomer)</b>: 11:00–20:00`
  },
  ruiloba:{
    es:`<b>Recepción</b>: 9:00–21:00<br><b>Restaurante</b>: 13:00–16:00 / 20:00–23:00`,
    en:`<b>Reception</b>: 9:00–21:00<br><b>Restaurant</b>: 13:00–16:00 / 20:00–23:00`,
    fr:`<b>Réception</b>: 9:00–21:00<br><b>Restaurant</b>: 13:00–16:00 / 20:00–23:00`,
    de:`<b>Rezeption</b>: 9:00–21:00<br><b>Restaurant</b>: 13:00–16:00 / 20:00–23:00`,
    nl:`<b>Receptie</b>: 9:00–21:00<br><b>Restaurant</b>: 13:00–16:00 / 20:00–23:00`
  },
  cardeo:{
    es:`<b>Taberna</b>: 12:30–16:00 / 19:30–23:30<br><b>Apartamentos</b>: check-in 16:00, check-out 11:00`,
    en:`<b>Tavern</b>: 12:30–16:00 / 19:30–23:30<br><b>Apartments</b>: check-in 16:00, check-out 11:00`,
    fr:`<b>Taverne</b>: 12:30–16:00 / 19:30–23:30<br><b>Appartements</b> : check-in 16:00, check-out 11:00`,
    de:`<b>Taverne</b>: 12:30–16:00 / 19:30–23:30<br><b>Appartements</b>: Check-in 16:00, Check-out 11:00`,
    nl:`<b>Taveerne</b>: 12:30–16:00 / 19:30–23:30<br><b>Appartementen</b>: check-in 16:00, check-out 11:00`
  }
};

const schedModal=document.getElementById("schedModal");
const schedBody=document.getElementById("schedBody");
const schedTitle=document.getElementById("schedTitle");
document.querySelectorAll("[data-sched]").forEach(b=>{
  b.addEventListener("click",()=>{
    const key=b.getAttribute("data-sched");
    const mapTitle={oyambre:"Oyambre",ramales:"Ramales",ruiloba:"Ruiloba",cardeo:"El Cardeo"};
    schedTitle.textContent = (I18N[LANG].schedulesTitle||"Horarios")+": "+mapTitle[key];
    schedBody.innerHTML = SCHEDULES[key]?.[LANG] || SCHEDULES[key]?.es || "";
    schedModal.style.display="flex";
  });
});
document.getElementById("closeSched").onclick=()=>schedModal.style.display="none";
schedModal.onclick=(e)=>{if(e.target===schedModal)schedModal.style.display="none";}

/* ───────────── ADMIN MODE (tap logo x5) ───────────── */
(function adminActivator(){
  const logo=document.getElementById('logoTap'); let taps=0,timer=null;
  logo?.addEventListener('click',()=>{
    taps++; clearTimeout(timer); timer=setTimeout(()=>{taps=0},1000);
    if(taps>=5){
      taps=0; const on=localStorage.getItem('admin')==='1';
      localStorage.setItem('admin',on?'0':'1');
      document.body.classList.toggle('admin-on',!on);
      const modal=document.getElementById('adminModal');
      if(!on){ modal.style.display='flex'; document.body.classList.add('modal-open'); loadEventsAdmin(); }
      else{ modal.style.display='none'; document.body.classList.remove('modal-open'); }
      alert(!on?'Modo admin activado':'Modo admin desactivado');
    }
  });
  document.body.classList.toggle('admin-on', localStorage.getItem('admin')==='1');
})();

/* ───────────── ADMIN PANEL ───────────── */
let ADMIN_EVENTS=[];

function isoFromLocal(dt){
  const d=new Date(dt); const tz=-d.getTimezoneOffset(); const sign=tz>=0?'+':'-';
  const hh=String(Math.floor(Math.abs(tz)/60)).padStart(2,'0');
  const mm=String(Math.abs(tz)%60).padStart(2,'0');
  return d.toISOString().slice(0,19)+sign+hh+':mm'.replace('mm',mm);
}
function slug(s){return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'').slice(0,60);}

async function loadEventsAdmin(){
  try{const r=await fetch(`./events.json?v=${Date.now()}`,{cache:'no-cache'}); const data=await r.json(); ADMIN_EVENTS=Array.isArray(data)?data:[];}
  catch(e){ADMIN_EVENTS=[];}
  renderAdminTable();
}
document.getElementById('openAdmin')?.addEventListener('click', ()=>{
  document.getElementById('adminModal').style.display='flex';
  document.body.classList.add('modal-open');
  loadEventsAdmin();
});
document.getElementById('closeAdmin')?.addEventListener('click', ()=>{
  document.getElementById('adminModal').style.display='none';
  document.body.classList.remove('modal-open');
});
document.getElementById('adminModal')?.addEventListener('click', (e)=>{
  if(e.target.id==='adminModal'){
    e.currentTarget.style.display='none';
    document.body.classList.remove('modal-open');
  }
});

function renderAdminTable(){
  const tbody=document.querySelector('#eventsTable tbody');
  tbody.innerHTML=ADMIN_EVENTS.sort((a,b)=>new Date(a.fecha)-new Date(b.fecha)).map(ev=>{
    const titleES=(typeof ev.titulo==='string'?ev.titulo:(ev.titulo?.es||''))||'';
    const lugarES=(typeof ev.lugar==='string'?ev.lugar:(ev.lugar?.es||''))||'';
    const img=(ev.imagen||ev.image||'');
    const dt=new Date(ev.fecha);
    const val=`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}T${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
    return `<tr data-id="${ev.id}">
      <td class="muted">${ev.id}</td>
      <td><input class="input" type="datetime-local" value="${val}"><div class="muted">${dt.toLocaleString()}</div></td>
      <td>
        <select class="select">
          <option value="oyambre" ${ev.camping==='oyambre'?'selected':''}>oyambre</option>
          <option value="ramales" ${ev.camping==='ramales'?'selected':''}>ramales</option>
          <option value="ruiloba" ${ev.camping==='ruiloba'?'selected':''}>ruiloba</option>
          <option value="cardeo"  ${ev.camping==='cardeo'?'selected':''}>cardeo</option>
        </select>
        <input class="input" style="margin-top:6px" placeholder="Lugar (ES)" value="${lugarES.replace(/"/g,'&quot;')}">
      </td>
      <td>
        <input class="input" placeholder="Título (ES)" value="${titleES.replace(/"/g,'&quot;')}">
        <textarea class="textarea" rows="2" placeholder="Descripción (ES)" style="margin-top:6px">${(ev.descripcion?.es||'').replace(/</g,'&lt;')}</textarea>
        <input class="input" data-img placeholder="Imagen (URL)" value="${img.replace(/"/g,'&quot;')}" style="margin-top:6px">
      </td>
      <td style="min-width:240px">
        <div class="row" style="gap:6px">
          <button class="btn small" data-action="save">Guardar</button>
          <button class="btn small" data-action="dup">Duplicar</button>
          <button class="btn small" data-action="del">Borrar</button>
        </div>
      </td>
    </tr>`;
  }).join('');
  tbody.querySelectorAll('tr').forEach(tr=>{
    const id=tr.getAttribute('data-id');
    tr.querySelector('[data-action="save"]').addEventListener('click',()=>saveRow(tr,id));
    tr.querySelector('[data-action="dup"]').addEventListener('click',()=>duplicateRow(id));
    tr.querySelector('[data-action="del"]').addEventListener('click',()=>deleteRow(id));
  });
}

function getRowValues(tr){
  const dtInput = tr.querySelector('td:nth-child(2) input[type="datetime-local"]');
  const campingSel = tr.querySelector('td:nth-child(3) select');
  const lugarInput = tr.querySelector('td:nth-child(3) input');
  const titleInput = tr.querySelector('td:nth-child(4) input:not([data-img])');
  const descTextarea = tr.querySelector('td:nth-child(4) textarea');
  const imgInput = tr.querySelector('td:nth-child(4) input[data-img]');
  return {
    dateLocal:dtInput.value,
    camping:campingSel.value,
    lugar:(lugarInput.value||'').trim(),
    titulo:(titleInput.value||'').trim(),
    desc:(descTextarea.value||'').trim(),
    img:(imgInput.value||'').trim()
  };
}
function saveRow(tr,id){
  const v=getRowValues(tr); if(!v.titulo||!v.dateLocal||!v.camping){alert('Rellena título, fecha y alojamiento.');return;}
  const idx=ADMIN_EVENTS.findIndex(e=>e.id===id); if(idx<0)return;
  ADMIN_EVENTS[idx].fecha=isoFromLocal(v.dateLocal);
  ADMIN_EVENTS[idx].camping=v.camping;
  ADMIN_EVENTS[idx].titulo={es:v.titulo};
  ADMIN_EVENTS[idx].lugar={es:v.lugar||defaultLugar(v.camping)};
  ADMIN_EVENTS[idx].descripcion={es:v.desc||''};
  if(v.img) ADMIN_EVENTS[idx].imagen=v.img; else delete ADMIN_EVENTS[idx].imagen;
  renderAdminTable();
}
function duplicateRow(id){
  const o=ADMIN_EVENTS.find(e=>e.id===id); if(!o)return;
  const titleES=o.titulo?.es||''; const newId=`ev-${slug(titleES)}-${o.camping}-${Date.now().toString().slice(-8)}`;
  const copy=JSON.parse(JSON.stringify(o)); copy.id=newId; ADMIN_EVENTS.push(copy); renderAdminTable();
}
function deleteRow(id){ if(!confirm('¿Borrar este evento?'))return; ADMIN_EVENTS=ADMIN_EVENTS.filter(e=>e.id!==id); renderAdminTable(); }
function defaultLugar(p){ if(p==='oyambre')return 'Camping Caravaning Playa de Oyambre'; if(p==='ramales')return 'Camping Ramales'; if(p==='ruiloba')return 'Camping El Helguero'; if(p==='cardeo')return 'Apartamentos El Cardeo'; return ''; }

document.getElementById('addEventBtn')?.addEventListener('click',()=>{
  const title=document.getElementById('evTitle').value.trim();
  const date=document.getElementById('evDate').value;
  const place=document.getElementById('evPlace').value;
  const lugar=(document.getElementById('evLugar').value.trim())||defaultLugar(place);
  const img=document.getElementById('evImg').value.trim();
  const desc=document.getElementById('evDesc').value.trim();
  if(!title||!date||!place){alert('Rellena título, fecha y alojamiento.');return;}
  const id=`ev-${slug(title)}-${place}-${date.replace(/[:T]/g,'').slice(0,12)}`;
  const obj={id,fecha:isoFromLocal(date),camping:place,titulo:{es:title},descripcion:{es:desc},lugar:{es:lugar}};
  if(img) obj.imagen=img;
  ADMIN_EVENTS.push(obj);
  renderAdminTable();
  document.getElementById('evTitle').value='';document.getElementById('evDate').value='';document.getElementById('evLugar').value='';document.getElementById('evImg').value='';document.getElementById('evDesc').value='';
});

document.getElementById('exportEventsBtn')?.addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(ADMIN_EVENTS,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='events.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* ZIP backup: events.json + imágenes */
document.getElementById('exportZipBtn')?.addEventListener('click', async ()=>{
  try{
    const zip=new JSZip();
    zip.file('events.json', JSON.stringify(ADMIN_EVENTS,null,2));
    const imgs=ADMIN_EVENTS.map(e=>e.imagen||e.image).filter(Boolean);
    const folder=zip.folder('images'); const added=new Set();
    await Promise.all(imgs.map(async (u)=>{
      if(added.has(u)) return;
      try{
        const res=await fetch(u,{mode:'cors'}); const blob=await res.blob(); const buf=await blob.arrayBuffer();
        const name=(u.split('/').pop()||'image').split('?')[0];
        folder.file(name,buf); added.add(u);
      }catch(err){ console.warn('No se pudo añadir la imagen:', u, err); }
    }));
    const blob=await zip.generateAsync({type:'blob'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='backup_acobijo.zip'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }catch(e){ alert('No se pudo generar la copia de seguridad.'); console.error(e); }
});

document.getElementById('importFile')?.addEventListener('change',async(e)=>{
  const f=e.target.files?.[0]; if(!f)return; try{const txt=await f.text(); const data=JSON.parse(txt); if(!Array.isArray(data))throw new Error('El JSON debe ser un array'); ADMIN_EVENTS=data; renderAdminTable();}
  catch(err){alert('No se pudo leer el JSON: '+err.message);} finally{e.target.value='';}
});

/* ───────────── GitHub API: guardar events.json ───────────── */
const GH_KEYS={repo:'ghRepo',branch:'ghBranch',token:'ghToken'};
function loadGhCfgToForm(){document.getElementById('ghRepo').value=localStorage.getItem(GH_KEYS.repo)||'';document.getElementById('ghBranch').value=localStorage.getItem(GH_KEYS.branch)||'main';document.getElementById('ghToken').value=localStorage.getItem(GH_KEYS.token)||'';}
function saveGhCfgFromForm(){localStorage.setItem(GH_KEYS.repo,document.getElementById('ghRepo').value.trim());localStorage.setItem(GH_KEYS.branch,document.getElementById('ghBranch').value.trim()||'main');const t=document.getElementById('ghToken').value.trim(); if(t) localStorage.setItem(GH_KEYS.token,t); alert('Configuración guardada en este dispositivo.');}
async function ghGet(path,token){const repo=localStorage.getItem(GH_KEYS.repo);const branch=localStorage.getItem(GH_KEYS.branch)||'main';const url=`https://api.github.com/repos/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;return fetch(url,{headers:{'Authorization':`Bearer ${token}`,'Accept':'application/vnd.github+json'}});}
async function ghPut(path,contentBase64,message,sha,token){const repo=localStorage.getItem(GH_KEYS.repo);const branch=localStorage.getItem(GH_KEYS.branch)||'main';const url=`https://api.github.com/repos/${repo}/contents/${encodeURIComponent(path)}`;const body={message,content:contentBase64,branch};if(sha)body.sha=sha;return fetch(url,{method:'PUT',headers:{'Authorization':`Bearer ${token}`,'Accept':'application/vnd.github+json','Content-Type':'application/json'},body:JSON.stringify(body)});}
function toB64(str){return btoa(unescape(encodeURIComponent(str)));}

document.getElementById('saveGhCfg')?.addEventListener('click',saveGhCfgFromForm);
document.getElementById('pushEventsBtn')?.addEventListener('click',saveEventsToGitHub);
document.getElementById('openAdmin')?.addEventListener('click',loadGhCfgToForm);

async function saveEventsToGitHub(){
  try{
    const token=localStorage.getItem(GH_KEYS.token); if(!token){alert('Configura el token en "Config GitHub".');return;}
    let sha=null, exists=false; let res=await ghGet('events.json',token);
    if(res.status===200){const data=await res.json(); sha=data.sha; exists=true;}
    else if(res.status!==404){alert('Error comprobando events.json: '+res.status);return;}
    const jsonStr=JSON.stringify(ADMIN_EVENTS,null,2); const content64=toB64(jsonStr);
    const now=new Date().toISOString().slice(0,19).replace('T',' ');
    res=await ghPut('events.json',content64,`Update events.json via in-app admin (${now})`,sha,token);
    if(res.ok){alert('✅ events.json subido correctamente a GitHub.');} else {const txt=await res.text(); alert('❌ Error subiendo a GitHub: '+res.status+'\n'+txt);}
  }catch(err){alert('❌ Excepción subiendo a GitHub: '+err.message);}
}

/* PWA install + SW */
let deferredPrompt;const installBtn=document.getElementById("installBtn");
window.addEventListener("beforeinstallprompt",(e)=>{e.preventDefault();deferredPrompt=e;installBtn.style.display="inline-flex"});
installBtn?.addEventListener("click",()=>{deferredPrompt?.prompt();deferredPrompt=null});
if("serviceWorker" in navigator) navigator.serviceWorker.register("./service-worker.js");
</script>
</body>
</html>
