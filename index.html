<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Grupo A Cobijo</title>
<meta name="description" content="App de experiencia del cliente: eventos, horarios y accesos del Grupo A Cobijo.">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0ea5e9">
<link rel="icon" href="assets/icons/icon-192.png">
<link rel="apple-touch-icon" href="assets/icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<style>
:root{
  --bg:#ffffff; --ink:#0a1a2a; --muted:#6b7280; --line:#e6eef7;
  --brand:#0ea5e9; --brand-ink:#063e63; --card:#f7fbff; --tint:#eef7ff;
}
body.dark{
  --bg:#0b1220; --ink:#e8eef7; --muted:#8fa2bd; --line:#1e2a40;
  --brand:#22b2ff; --brand-ink:#bfe7ff; --card:#111a2a; --tint:#0f1a2b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;color:var(--ink);background:var(--bg);transition:background-color .15s,color .15s}

/* Topbar */
.topbar{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#e6f6ff,#ffffff);
  border-bottom:1px solid var(--line);display:flex;align-items:center;gap:.75rem;padding:.7rem .9rem}
body.dark .topbar{background:linear-gradient(180deg,#0e1a2c,#0b1220)}
.topbar .burger{border:none;background:#fff;border:1px solid var(--line);border-radius:10px;padding:.45rem .55rem;cursor:pointer}
body.dark .topbar .burger{background:#0f1a2b}
.topbar .brand{display:flex;align-items:center;gap:.6rem}
.topbar img{height:40px;width:auto;object-fit:contain}
.topbar h1{font-size:1rem;margin:0}
.lang-btn,.theme-btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:.35rem .6rem;cursor:pointer}
body.dark .lang-btn, body.dark .theme-btn{background:#0f1a2b}

/* Drawer */
.drawer{position:fixed;inset:0;z-index:30;display:none}
.drawer.open{display:block}
.drawer .back{position:absolute;inset:0;background:rgba(0,0,0,.35)}
.drawer .panel{position:absolute;inset:0 auto 0 0;width:min(86vw,320px);background:#fff;border-right:1px solid var(--line);
  padding:14px;display:flex;flex-direction:column;gap:8px}
body.dark .drawer .panel{background:#0f1a2b}
.drawer .item{display:flex;gap:.6rem;align-items:center;border:1px solid var(--line);border-radius:12px;padding:.6rem .7rem;background:var(--tint);cursor:pointer}
.drawer .muted{color:var(--muted);font-size:.85rem}
/* üîí Ocultar admin en el men√∫ por defecto; mostrar SOLO en admin-on */
.drawer .item.admin-btn{display:none !important;}
.admin-on .drawer .item.admin-btn{display:flex !important;}

/* Views */
main{padding:12px 12px 76px;max-width:980px;margin:0 auto}
.view{display:none;animation:fade .15s ease-out}
.view.active{display:block}
@keyframes fade{from{opacity:.6;transform:translateY(4px)} to{opacity:1;transform:none}}

/* Home */
.hero{position:relative;border:1px solid var(--line);border-radius:18px;overflow:hidden;background:
  radial-gradient(120% 80% at 100% 0%,#b7e6ff 0%,#e6f6ff 50%,#ffffff 100%)}
body.dark .hero{background:radial-gradient(120% 80% at 100% 0%,#143356 0%,#0f2239 50%,#0b1220 100%)}
.hero-inner{display:flex;align-items:center;gap:14px;padding:16px}
.hero img{height:64px;width:auto}
.hero h2{margin:0;font-size:1.3rem}
.badge{display:inline-flex;gap:.4rem;align-items:center;border:1px solid var(--line);background:#fff;border-radius:999px;padding:.25rem .6rem;font-size:.8rem;color:var(--muted)}
body.dark .badge{background:#0f1a2b}
.tiles{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:12px}
.tile{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:6px;
  align-items:flex-start;cursor:pointer;box-shadow:0 8px 24px rgba(14,165,233,.06)}
.tile .big{font-size:1.6rem}
.tile .muted{color:var(--muted);font-size:.86rem}
.tile:active{transform:scale(.98)}

.hscroll{display:flex;gap:10px;overflow:auto;padding-bottom:6px;scrollbar-gutter:stable both-edges}
.card{min-width:260px;flex:0 0 auto;background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px}
body.dark .card{background:#0f1a2b}
.card img{width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:10px;border:1px solid var(--line);background:#f2f6fb}
.card .title{font-weight:700;margin-top:6px}
.card .meta{font-size:.85rem;color:var(--muted)}
.row{display:flex;flex-wrap:wrap;gap:6px}
.btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:.4rem .6rem;cursor:pointer;font-weight:600;color:var(--ink)}
body.dark .btn{background:#0f1a2b}
.btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}

/* Events filters */
.filters{display:flex;gap:6px;flex-wrap:wrap;margin:10px 0}
.chip{border:1px solid var(--line);background:#fff;border-radius:999px;padding:.35rem .7rem;cursor:pointer}
body.dark .chip{background:#0f1a2b}
.chip.on{background:var(--brand);color:#fff;border-color:var(--brand)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}

/* Campings */
.place{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px}
.place h3{margin:0 0 2px}
.map{width:100%;aspect-ratio:16/10;border-radius:12px;overflow:hidden;border:1px solid var(--line)}
.map iframe{width:100%;height:100%;border:0; background:#fff}

/* Schedules (accordion) */
.acc{display:flex;flex-direction:column;gap:8px}
.acc-item{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff}
body.dark .acc-item{background:#0f1a2b}
.acc-h{display:flex;justify-content:space-between;align-items:center;padding:.7rem .8rem;cursor:pointer;background:var(--tint)}
.acc-b{display:none;padding:.8rem}
.acc-item.open .acc-b{display:block}

/* Bottom nav */
.navbar{position:fixed;left:0;right:0;bottom:0;z-index:25;background:#fff;border-top:1px solid var(--line);display:grid;grid-template-columns:repeat(4,1fr)}
body.dark .navbar{background:#0f1a2b}
.navbtn{display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 4px;border:none;background:transparent;cursor:pointer;font-size:.8rem;color:var(--muted)}
.navbtn.active{color:var(--brand-ink);font-weight:700}
.navbtn .ico{font-size:1.1rem}

/* Modal base */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1000}
.modal{width:min(92vw,920px);max-height:88vh;overflow:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;
  background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 28px rgba(0,0,0,.2)}
body.dark .modal{background:#0f1a2b}
/* ‚úï mejorada */
.close{background:transparent;border:none;color:var(--muted);font-weight:700;cursor:pointer;
  font-size:1.6rem;line-height:1;padding:.25rem .5rem;border-radius:10px;float:right}
.close:active{transform:scale(.95)}
body.modal-open{overflow:hidden}

/* Admin button (placeholder) */
.admin-btn{}
.muted{color:var(--muted);font-size:.9rem}

/* Tabla admin simple */
.table{width:100%;border-collapse:collapse;font-size:.9rem}
.table th,.table td{border:1px solid var(--line);padding:6px 8px;text-align:left;vertical-align:top}
.table th{background:var(--tint)}
.input,.select,.textarea{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}

/* Extra peque√±os estilos para nuevas vistas */
.kbd{font:12px/1.4 ui-monospace,monospace;background:var(--tint);border:1px solid var(--line);border-radius:8px;padding:2px 6px}
.small{font-size:.85rem}
</style>
</head>
<body>

<!-- Topbar -->
<header class="topbar">
  <button id="menuBtn" class="burger" aria-label="Abrir men√∫">‚ò∞</button>
  <div class="brand">
    <img src="assets/logo.png" alt="Grupo A Cobijo" id="logoTap">
    <h1 id="t-app">Grupo A Cobijo</h1>
  </div>
  <div style="flex:1"></div>
  <button class="theme-btn" id="themeBtn" title="Tema" aria-label="Cambiar tema">üåô</button>
  <button class="lang-btn" id="langBtn" aria-haspopup="dialog">üåê ES</button>
</header>

<!-- Drawer -->
<div class="drawer" id="drawer">
  <div class="back" id="drawerBack"></div>
  <aside class="panel" role="menu" aria-label="Navegaci√≥n">
    <div class="item" data-nav="home">üè† <strong>Inicio</strong></div>
    <div class="item" data-nav="events">üìÖ <strong>Eventos</strong></div>
    <div class="item" data-nav="places">üèïÔ∏è <strong>Campings</strong></div>
    <div class="item" data-nav="schedules">üïí <strong>Horarios</strong></div>
    <!-- Nuevas entradas cliente -->
    <div class="item" data-nav="stay">üõéÔ∏è <strong>Mi estancia</strong></div>
    <div class="item" data-nav="weather">üå§Ô∏è <strong>Clima</strong></div>
    <div class="item" data-nav="pois">üìç <strong>Puntos √∫tiles</strong></div>
    <div class="item" data-nav="incidents">üõ†Ô∏è <strong>Incidencias</strong></div>
    <div class="item admin-btn" id="openAdmin">üõ†Ô∏è <strong>Admin</strong></div>
  </aside>
</div>

<main>
  <!-- HOME -->
  <section id="view-home" class="view active">
    <div class="hero">
      <div class="hero-inner">
        <img src="assets/logo.png" alt="A Cobijo">
        <div>
          <h2 id="t-hello">¬°Bienvenido!</h2>
          <div class="badge" id="t-badge">Oyambre, Ramales, Ruiloba y Cardeo</div>
        </div>
      </div>
      <div class="tiles">
        <div class="tile" data-nav="events"><div class="big">üìÖ</div><div><strong id="t-ev">Eventos</strong><div class="muted" id="t-ev-sub">Qu√© hay hoy</div></div></div>
        <div class="tile" data-nav="places"><div class="big">üèïÔ∏è</div><div><strong id="t-pl">Campings</strong><div class="muted" id="t-pl-sub">Accesos r√°pidos</div></div></div>
        <div class="tile" data-nav="schedules"><div class="big">üïí</div><div><strong id="t-sc">Horarios</strong><div class="muted" id="t-sc-sub">Recepci√≥n ¬∑ bar</div></div></div>
        <div class="tile" id="installTile"><div class="big">‚¨áÔ∏è</div><div><strong id="t-inst">Instalar</strong><div class="muted" id="t-inst-sub">A√±adir a inicio</div></div></div>
        <!-- Nuevos tiles -->
        <div class="tile" data-nav="stay"><div class="big">üõéÔ∏è</div><div><strong id="t-st">Mi estancia</strong><div class="muted" id="t-st-sub">Wi-Fi ¬∑ normas</div></div></div>
        <div class="tile" data-nav="weather"><div class="big">üå§Ô∏è</div><div><strong id="t-we">Clima</strong><div class="muted" id="t-we-sub">Hoy y previsi√≥n</div></div></div>
        <div class="tile" data-nav="incidents"><div class="big">üõ†Ô∏è</div><div><strong id="t-in">Incidencias</strong><div class="muted" id="t-in-sub">Av√≠sanos r√°pido</div></div></div>
      </div>
    </div>

    <h3 style="margin:14px 4px 8px">Pr√≥ximos eventos</h3>
    <div id="homeEvents" class="hscroll"></div>
  </section>

  <!-- EVENTOS -->
  <section id="view-events" class="view">
    <h2 id="t-events-title">Eventos</h2>
    <div class="filters">
      <button class="chip on" data-filter="all" id="f-all">Todos</button>
      <button class="chip" data-filter="today" id="f-today">Hoy</button>
      <button class="chip" data-filter="tomorrow" id="f-tomorrow">Ma√±ana</button>
      <button class="chip" data-filter="week" id="f-week">Esta semana</button>
    </div>
    <div class="filters">
      <button class="chip on" data-camp="all" id="c-all">Todos los campings</button>
      <button class="chip" data-camp="oyambre" id="c-oy">Oyambre</button>
      <button class="chip" data-camp="ramales" id="c-ra">Ramales</button>
      <button class="chip" data-camp="ruiloba" id="c-he">Ruiloba</button>
      <button class="chip" data-camp="cardeo" id="c-ca">El Cardeo</button>
    </div>
    <div id="eventsGrid" class="grid"></div>
    <p class="muted" id="eventsEmpty" style="display:none">Sin eventos por ahora.</p>
  </section>

  <!-- CAMPINGS -->
  <section id="view-places" class="view">
    <h2 id="t-campings-title">Nuestros campings</h2>
    <div class="grid">

      <article class="place">
        <h3 id="t-oy-title">Camping Caravaning Playa de Oyambre</h3>
        <p class="muted" id="t-oy-hint">Todos los servicios 1KM de la Playa Mascotas Bienvenidas</p>
        <div class="row">
          <a class="btn" data-i18n-web href="https://www.oyambre.com" target="_blank" rel="noopener">Web</a>
          <a class="btn" data-i18n-call href="tel:+34942711461">Llamar</a>
          <a class="btn" data-i18n-directions href="https://maps.google.com/?q=Camping+Caravaning+Playa+de+Oyambre" target="_blank" rel="noopener">C√≥mo llegar</a>
          <a class="btn primary" data-i18n-whatsapp href="https://wa.me/34675696212" target="_blank" rel="noopener">WhatsApp</a>
        </div>
        <div class="map"><iframe src="https://www.google.com/maps?q=Camping+Caravaning+Playa+de+Oyambre&output=embed" loading="lazy"></iframe></div>
      </article>

      <article class="place">
        <h3 id="t-ra-title">Camping Ramales</h3>
        <p class="muted" id="t-ra-hint">Mascotas Bienvenidas ¬∑ Monta√±a ¬∑ Actividades ¬∑ Piscina Cubierta</p>
        <div class="row">
          <a class="btn" data-i18n-web href="https://www.campingramales.com" target="_blank" rel="noopener">Web</a>
          <a class="btn" data-i18n-call href="tel:+34654463133">Llamar</a>
          <a class="btn" data-i18n-directions href="https://maps.google.com/?q=Camping+Ramales" target="_blank" rel="noopener">C√≥mo llegar</a>
          <a class="btn primary" data-i18n-whatsapp href="https://wa.me/34654463133" target="_blank" rel="noopener">WhatsApp</a>
        </div>
        <div class="map"><iframe src="https://www.google.com/maps?q=Camping+Ramales&output=embed" loading="lazy"></iframe></div>
      </article>

      <article class="place">
        <h3 id="t-he-title">Camping El Helguero (Ruiloba)</h3>
        <p class="muted" id="t-he-hint">Naturaleza ¬∑ Familiar ¬∑ Mascotas Bienvenidas</p>
        <div class="row">
          <a class="btn" data-i18n-web href="https://www.campingelhelguero.com" target="_blank" rel="noopener">Web</a>
          <a class="btn" data-i18n-call href="tel:+34942722124">Llamar</a>
          <a class="btn" data-i18n-directions href="https://maps.google.com/?q=Camping+El+Helguero" target="_blank" rel="noopener">C√≥mo llegar</a>
          <a class="btn primary" data-i18n-whatsapp href="https://wa.me/34652806564" target="_blank" rel="noopener">WhatsApp</a>
        </div>
        <div class="map"><iframe src="https://www.google.com/maps?q=Camping+El+Helguero&output=embed" loading="lazy"></iframe></div>
      </article>

      <article class="place">
        <h3 id="t-ca-title">Apartamentos / Taberna El Cardeo</h3>
        <p class="muted" id="t-ca-hint">Apartamentos + Taberna ¬∑ Mascotas Bienvenidas</p>
        <div class="row">
          <a class="btn" data-i18n-web href="https://www.elcardeo.es" target="_blank" rel="noopener">Web</a>
          <a class="btn" data-i18n-call href="tel:+34664686158">Llamar</a>
          <a class="btn" data-i18n-directions href="https://maps.app.goo.gl/XCzaYGDDLk2CQ8VK6" target="_blank" rel="noopener">C√≥mo llegar</a>
          <a class="btn primary" data-i18n-whatsapp href="https://wa.me/34664686158" target="_blank" rel="noopener">WhatsApp</a>
        </div>
        <div class="map"><iframe src="https://www.google.com/maps?q=Apartamentos+El+Cardeo&output=embed" loading="lazy"></iframe></div>
      </article>

    </div>
  </section>

  <!-- HORARIOS -->
  <section id="view-schedules" class="view">
    <h2 id="t-schedules-title">Horarios</h2>
    <div class="acc" id="acc">
      <div class="acc-item">
        <div class="acc-h" data-acc="oyambre">Oyambre <span>‚ñº</span></div>
        <div class="acc-b" id="acc-oyambre"></div>
      </div>
      <div class="acc-item">
        <div class="acc-h" data-acc="ramales">Ramales <span>‚ñº</span></div>
        <div class="acc-b" id="acc-ramales"></div>
      </div>
      <div class="acc-item">
        <div class="acc-h" data-acc="ruiloba">Ruiloba <span>‚ñº</span></div>
        <div class="acc-b" id="acc-ruiloba"></div>
      </div>
      <div class="acc-item">
        <div class="acc-h" data-acc="cardeo">El Cardeo <span>‚ñº</span></div>
        <div class="acc-b" id="acc-cardeo"></div>
      </div>
    </div>
    <p class="muted" id="schedNote">Info orientativa. Pregunta en recepci√≥n para cambios de temporada.</p>
  </section>

  <!-- üÜï MI ESTANCIA -->
  <section id="view-stay" class="view">
    <h2 id="t-stay-title">Mi estancia</h2>
    <article class="card" style="min-width:unset">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
        <div>
          <div><b>Wi-Fi</b></div>
          <div>SSID: <span id="wifiSsid">Pregunte en recepci√≥n la WIFI correcta</span></div>
          <div>Clave: <span id="wifiPass" class="kbd">acobijo2025</span></div>
          <div class="row" style="margin-top:6px">
            <button class="btn" id="copyWifi">Sin Contrase√±a</button>
          </div>
        </div>
        <div>
          <div><b>Horarios clave</b></div>
          <div>Recepci√≥n: <span id="recHours">09:00‚Äì21:00</span></div>
          <div>Check-in: 15:00 ¬∑ Check-out: 12:00</div>
        </div>
        <div>
          <div><b>Normas r√°pidas</b></div>
          <ul style="margin:8px 0 0 18px">
            <li>Silencio: 00:00‚Äì08:00</li>
            <li>Velocidad interior: 10 km/h</li>
            <li>Mascotas con correa y recoger excrementos</li>
          </ul>
        </div>
        <div>
          <div><b>Emergencias</b></div>
          <div>112 (general) ¬∑ 061 (sanitaria) ¬∑ 062 (Guardia Civil)</div>
          <div class="row" style="margin-top:6px">
            <a class="btn" href="tel:112">Llamar 112</a>
            <a class="btn" href="tel:061">Llamar 061</a>
          </div>
        </div>
      </div>
    </article>
  </section>

  <!-- üÜï CLIMA -->
  <section id="view-weather" class="view">
    <h2>Clima</h2>
    <article class="card" id="weatherCard">
      <div class="small muted">Cargando previsi√≥n‚Ä¶</div>
    </article>
  </section>

  <!-- üÜï POIs -->
  <section id="view-pois" class="view">
    <h2>Puntos √∫tiles</h2>
    <div class="grid" id="poisGrid"></div>
    <p class="muted">Activa la ubicaci√≥n del dispositivo para calcular distancia/tiempo andando.</p>
  </section>

  <!-- üÜï INCIDENCIAS -->
  <section id="view-incidents" class="view">
    <h2>Incidencias y peticiones</h2>
    <article class="card" style="min-width:unset">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px">
        <label>T√≠tulo
          <input id="iTitle" class="input" placeholder="Ej.: Bombilla fundida en parcela 42">
        </label>
        <label>Ubicaci√≥n
          <input id="iPlace" class="input" placeholder="Parcela / Bungalow / Zona">
        </label>
        <label style="grid-column:1/-1">Detalle
          <textarea id="iDetail" class="textarea" rows="4" placeholder="Cu√©ntanos brevemente el problema‚Ä¶"></textarea>
        </label>
        <label>Foto (opcional)
          <input id="iPhoto" type="file" accept="image/*" class="input">
        </label>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="sendWhats">Enviar por WhatsApp</button>
        <button class="btn" id="sendEmail">Enviar por Email</button>
        <button class="btn" id="copyTxt">Copiar texto</button>
      </div>
      <p class="muted" style="margin-top:6px">Si lo permites, incluimos enlace de tu ubicaci√≥n para acelerar la atenci√≥n.</p>
    </article>
  </section>
</main>

<!-- Bottom nav -->
<nav class="navbar" role="navigation" aria-label="Pesta√±as">
  <button class="navbtn active" data-nav="home"><div class="ico">üè†</div><div id="n-home">Inicio</div></button>
  <button class="navbtn" data-nav="events"><div class="ico">üìÖ</div><div id="n-ev">Eventos</div></button>
  <button class="navbtn" data-nav="places"><div class="ico">üèïÔ∏è</div><div id="n-pl">Campings</div></button>
  <button class="navbtn" data-nav="schedules"><div class="ico">üïí</div><div id="n-sc">Horarios</div></button>
</nav>

<!-- ADMIN MODAL (sin cambios estructurales) -->
<div class="backdrop" id="adminModal" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
  <div class="modal">
    <button class="close" id="closeAdmin" aria-label="Cerrar">‚úï</button>
    <h3 id="adminTitle">Gesti√≥n de eventos</h3>

    <div class="card" style="margin-top:8px">
      <h4 style="margin:0 0 8px">A√±adir evento</h4>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px">
        <div><label>T√≠tulo (ES)</label><input id="evTitle" class="input" placeholder="Ej: Concierto ac√∫stico"></div>
        <div><label>Fecha y hora</label><input id="evDate" type="datetime-local" class="input"></div>
        <div><label>Alojamiento</label>
          <select id="evPlace" class="select">
            <option value="oyambre">Oyambre</option>
            <option value="ramales">Ramales</option>
            <option value="ruiloba">Ruiloba</option>
            <option value="cardeo">El Cardeo</option>
          </select>
        </div>
        <div><label>Lugar (ES)</label><input id="evLugar" class="input" placeholder="Ej: Camping Ramales"></div>
        <div><label>Imagen (URL)</label><input id="evImg" class="input" placeholder="https://..."></div>
        <div style="grid-column:1/-1"><label>Descripci√≥n (ES)</label><textarea id="evDesc" class="textarea" rows="3" placeholder="Ej: M√∫sica en directo."></textarea></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="addEventBtn" class="btn">Agregar a la lista</button>
        <button id="exportEventsBtn" class="btn">Descargar events.json</button>
        <button id="exportZipBtn" class="btn">Descargar copia (ZIP)</button>
        <label class="btn" for="importFile" style="cursor:pointer">Importar JSON</label>
        <input id="importFile" type="file" accept="application/json" style="display:none">
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4 style="margin:0 0 8px">Eventos actuales</h4>

      <div class="row" style="margin:6px 0">
        <div style="flex:1;min-width:200px">
          <label>Filtrar por camping</label>
          <select id="adminFilterCamp" class="select">
            <option value="all">Todos</option>
            <option value="oyambre">oyambre</option>
            <option value="ramales">ramales</option>
            <option value="ruiloba">ruiloba</option>
            <option value="cardeo">cardeo</option>
          </select>
        </div>
        <div style="flex:1;min-width:200px">
          <label>Orden por fecha</label>
          <select id="adminSortOrder" class="select">
            <option value="asc">Ascendente</option>
            <option value="desc">Descendente</option>
          </select>
        </div>
      </div>

      <div style="overflow:auto">
        <table class="table" id="eventsTable">
          <thead>
            <tr><th>ID</th><th>Fecha</th><th>Alojamiento</th><th>T√≠tulo</th><th>Acciones</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="muted">Pulsa ‚ÄúDescargar events.json‚Äù y s√∫belo a GitHub, o usa la subida directa m√°s abajo.</p>
    </div>

    <div class="card" style="margin-top:12px">
      <h4>Config GitHub</h4>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px">
        <div><label>Repositorio (owner/repo)</label><input id="ghRepo" class="input" placeholder="owner/repo"></div>
        <div><label>Branch</label><input id="ghBranch" class="input" placeholder="main" value="main"></div>
        <div style="grid-column:1/-1"><label>Token (solo se guarda en este dispositivo)</label><input id="ghToken" class="input" placeholder="github_pat_..." autocomplete="off"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="saveGhCfg" class="btn">Guardar configuraci√≥n</button>
        <button id="pushEventsBtn" class="btn">üíæ Guardar en GitHub (events.json)</button>
      </div>
      <p class="muted">El token no se sube a ning√∫n servidor; queda en tu dispositivo (localStorage).</p>
    </div>

    <!-- Gesti√≥n de horarios -->
    <div class="card" style="margin-top:12px">
      <h4>Gesti√≥n de horarios (schedules.json)</h4>
      <p class="muted">Formato: {"oyambre":{"es":"...","en":"..."},"ramales":...}</p>
      <textarea id="schedJsonArea" class="textarea" rows="10" placeholder='Pegue aqu√≠ su schedules.json'></textarea>
      <div class="row" style="margin-top:10px">
        <button id="schedApplyBtn" class="btn">Aplicar cambios</button>
        <button id="exportSchedBtn" class="btn">Descargar schedules.json</button>
        <label class="btn" for="importSchedFile" style="cursor:pointer">Importar JSON</label>
        <input id="importSchedFile" type="file" accept="application/json" style="display:none">
        <button id="pushSchedBtn" class="btn">üíæ Guardar en GitHub (schedules.json)</button>
      </div>
    </div>

    <!-- Seguridad -->
    <div class="card" style="margin-top:12px">
      <h4>Seguridad</h4>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px">
        <div>
          <label>Nueva contrase√±a admin</label>
          <input id="adminPinInput" class="input" placeholder="M√≠n. 4 caracteres">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="saveAdminPin" class="btn">Guardar contrase√±a</button>
      </div>
      <p class="muted">Se guarda SOLO en este dispositivo (localStorage). Se pedir√° al activar admin con 5 toques.</p>
    </div>

  </div>
</div>

<!-- Idiomas modal -->
<div class="backdrop" id="langModal">
  <div class="modal">
    <button id="closeLang" class="close" aria-label="Cerrar">‚úï</button>
    <h3 id="langTitle">Selecciona idioma</h3>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px">
      <button class="btn lang-option" data-lang="es">üá™üá∏ Espa√±ol</button>
      <button class="btn lang-option" data-lang="en">üá¨üáß English</button>
      <button class="btn lang-option" data-lang="fr">üá´üá∑ Fran√ßais</button>
      <button class="btn lang-option" data-lang="de">üá©üá™ Deutsch</button>
      <button class="btn lang-option" data-lang="nl">üá≥üá± Nederlands</button>
    </div>
  </div>
</div>

<!-- JSZip -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function(){

  /* ===== Estado admin + PIN por defecto ===== */
  localStorage.setItem('admin','0');
  document.body.classList.remove('admin-on');
  if(!localStorage.getItem('admin_pin')){ localStorage.setItem('admin_pin','311974'); }

  /* ===== Utils ===== */
  function $(sel){return document.querySelector(sel);}
  function $all(sel){return Array.prototype.slice.call(document.querySelectorAll(sel));}
  function on(el,ev,fn){ if(el) el.addEventListener(ev,fn); }
  function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
  function safeUrl(u){var s=String(u||'').trim(); if(/^https?:\/\//i.test(s)||/^\/|^\.\.?\//.test(s)||/^data:image\//i.test(s)){return s.replace(/"/g,'%22');} return '';}

  /* ===== Tema claro/oscuro ===== */
  function detectTheme(){
    var saved = localStorage.getItem('theme');
    if(saved) return saved;
    try{ if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) return 'dark'; }catch(e){}
    return 'light';
  }
  function applyTheme(mode){
    document.body.classList.toggle('dark', mode==='dark');
    var themeBtn = $('#themeBtn');
    if(themeBtn) themeBtn.textContent = mode==='dark' ? '‚òÄÔ∏è' : 'üåô';
    localStorage.setItem('theme', mode);
    var meta = document.querySelector('meta[name="theme-color"]');
    if(meta) meta.setAttribute('content', mode==='dark' ? '#0b1220' : '#0ea5e9');
  }
  var THEME = detectTheme();
  applyTheme(THEME);
  on($('#themeBtn'),'click', function(){ THEME = (THEME==='dark') ? 'light' : 'dark'; applyTheme(THEME); });

  /* ===== i18n ===== */
  var I18N = {
    es:{app:"Grupo A Cobijo",hello:"¬°Bienvenido!",badge:"PWA ¬∑ Offline ¬∑ Multidioma",
        ev:"Eventos", evSub:"Qu√© hay hoy", pl:"Campings", plSub:"Accesos r√°pidos", sc:"Horarios", scSub:"Recepci√≥n ¬∑ bar",
        inst:"Instalar", instSub:"A√±adir a inicio",
        eventsTitle:"Eventos", schedulesTitle:"Horarios", campingsTitle:"Nuestros campings",
        fAll:"Todos", fToday:"Hoy", fTomorrow:"Ma√±ana", fWeek:"Esta semana",
        cAll:"Todos los campings", cOy:"Oyambre", cRa:"Ramales", cHe:"Ruiloba", cCa:"El Cardeo",
        web:"Web", call:"Llamar", directions:"C√≥mo llegar", whatsapp:"WhatsApp",
        oyTitle:"Camping Caravaning Playa de Oyambre", oyHint:"Todos los servicios ¬∑ Frente al mar",
        raTitle:"Camping Ramales", raHint:"Cuevas ¬∑ Monta√±a ¬∑ Actividades",
        heTitle:"Camping El Helguero (Ruiloba)", heHint:"Naturaleza ¬∑ Familiar ¬∑ Mascotas",
        caTitle:"Apartamentos / Taberna El Cardeo", caHint:"Apartamentos + Taberna",
        schedNote:"Info orientativa. Pregunta en recepci√≥n para cambios de temporada.",
        nHome:"Inicio", nEv:"Eventos", nPl:"Campings", nSc:"Horarios",
        /* Nuevas */
        stayTitle:"Mi estancia", st:"Mi estancia", stSub:"Wi-Fi ¬∑ normas",
        weather:"Clima", we:"Clima", weSub:"Hoy y previsi√≥n",
        incidents:"Incidencias", inSub:"Av√≠sanos r√°pido",
        fav:"‚≠ê Favorito", favOk:"‚≠ê Favorito ‚úì", addCal:"üìÖ A√±adir a calendario",
        copy:"Copiar", copied:"Copiado"
    },
    en:{app:"Grupo A Cobijo",hello:"Welcome!",badge:"PWA ¬∑ Offline ¬∑ Multilingual",
        ev:"Events", evSub:"What's on today", pl:"Campsites", plSub:"Quick access", sc:"Schedules", scSub:"Reception ¬∑ bar",
        inst:"Install", instSub:"Add to Home",
        eventsTitle:"Events", schedulesTitle:"Schedules", campingsTitle:"Our campsites",
        fAll:"All", fToday:"Today", fTomorrow:"Tomorrow", fWeek:"This week",
        cAll:"All campsites", cOy:"Oyambre", cRa:"Ramales", cHe:"Ruiloba", cCa:"El Cardeo",
        web:"Website", call:"Call", directions:"Directions", whatsapp:"WhatsApp",
        oyTitle:"Camping Caravaning Playa de Oyambre", oyHint:"All services ¬∑ By the sea",
        raTitle:"Camping Ramales", raHint:"Caves ¬∑ Mountains ¬∑ Activities",
        heTitle:"Camping El Helguero (Ruiloba)", heHint:"Nature ¬∑ Family ¬∑ Pets",
        caTitle:"El Cardeo Apartments / Tavern", caHint:"Apartments + Tavern",
        schedNote:"Indicative info. Check reception for seasonal changes.",
        nHome:"Home", nEv:"Events", nPl:"Camps", nSc:"Schedules",
        /* New */
        stayTitle:"My stay", st:"My stay", stSub:"Wi-Fi ¬∑ rules",
        weather:"Weather", we:"Weather", weSub:"Today & forecast",
        incidents:"Issues", inSub:"Contact us fast",
        fav:"‚≠ê Favorite", favOk:"‚≠ê Favorite ‚úì", addCal:"üìÖ Add to calendar",
        copy:"Copy", copied:"Copied"
    }
  };
  function detectLang(){ var s=localStorage.getItem('lang'); if(s) return s; var n=(navigator.language||'es').slice(0,2).toLowerCase(); return I18N[n]?n:'es'; }
  var LANG = detectLang();
  function t(id,v){ var el=document.getElementById(id); if(el) el.textContent=v; }
  function applyLang(){
    var T=I18N[LANG];
    t("t-app",T.app); t("t-hello",T.hello); t("t-badge",T.badge);
    t("t-ev",T.ev); t("t-ev-sub",T.evSub); t("t-pl",T.pl); t("t-pl-sub",T.plSub); t("t-sc",T.sc); t("t-sc-sub",T.scSub);
    t("t-inst",T.inst); t("t-inst-sub",T.instSub);
    t("t-events-title",T.eventsTitle); t("t-schedules-title",T.schedulesTitle); t("t-campings-title",T.campingsTitle);
    t("f-all",T.fAll); t("f-today",T.fToday); t("f-tomorrow",T.fTomorrow); t("f-week",T.fWeek);
    t("c-all",T.cAll); t("c-oy",T.cOy); t("c-ra",T.cRa); t("c-he",T.cHe); t("c-ca",T.cCa);
    t("t-oy-title",T.oyTitle); t("t-oy-hint",T.oyHint); t("t-ra-title",T.raTitle); t("t-ra-hint",T.raHint);
    t("t-he-title",T.heTitle); t("t-he-hint",T.heHint); t("t-ca-title",T.caTitle); t("t-ca-hint",T.caHint);
    t("schedNote",T.schedNote);
    t("t-stay-title",T.stayTitle); t("t-st",T.st); t("t-st-sub",T.stSub);
    t("t-we",T.we); t("t-we-sub",T.weSub);
    t("t-in",T.incidents); t("t-in-sub",T.inSub);
    var nh=$('#n-home'), ne=$('#n-ev'), np=$('#n-pl'), ns=$('#n-sc');
    if(nh) nh.textContent=T.nHome; if(ne) ne.textContent=T.nEv; if(np) np.textContent=T.nPl; if(ns) ns.textContent=T.nSc;
    $all("[data-i18n-web]").forEach(function(e){e.textContent=T.web;});
    $all("[data-i18n-call]").forEach(function(e){e.textContent=T.call;});
    $all("[data-i18n-directions]").forEach(function(e){e.textContent=T.directions;});
    $all("[data-i18n-whatsapp]").forEach(function(e){e.textContent=T.whatsapp;});
    var lb=$('#langBtn'); if(lb){ lb.textContent='üåê '+LANG.toUpperCase(); }
  }
  applyLang();

  on($('#langBtn'),'click', function(){ var m=$('#langModal'); if(m) m.style.display='flex'; });
  on($('#closeLang'),'click', function(e){ e.preventDefault(); var m=$('#langModal'); if(m) m.style.display='none'; });
  $all('.lang-option').forEach(function(b){
    on(b,'click', function(){
      LANG=b.getAttribute('data-lang'); localStorage.setItem('lang',LANG);
      applyLang(); loadEvents(); renderAcc();
      var m=$('#langModal'); if(m) m.style.display='none';
    });
  });

  /* ===== Navegaci√≥n ===== */
  function showView(id){
    $all('.view').forEach(function(v){ v.classList.remove('active'); });
    var target=document.getElementById('view-'+id); if(target) target.classList.add('active');
    $all('.navbtn').forEach(function(b){ b.classList.toggle('active', b.getAttribute('data-nav')===id); });
    var dr=$('#drawer'); if(dr) dr.classList.remove('open');
  }
  $all('[data-nav]').forEach(function(el){
    on(el,'click', function(){ showView(el.getAttribute('data-nav')); });
  });
  on($('#menuBtn'),'click', function(){ var d=$('#drawer'); if(d) d.classList.add('open'); });
  on($('#drawerBack'),'click', function(){ var d=$('#drawer'); if(d) d.classList.remove('open'); });

  /* ===== Datos comunes ===== */
  var PLACE_LINK={oyambre:"https://maps.google.com/?q=Camping+Caravaning+Playa+de+Oyambre",ramales:"https://maps.google.com/?q=Camping+Ramales",ruiloba:"https://maps.google.com/?q=Camping+El+Helguero",cardeo:"https://maps.app.goo.gl/XCzaYGDDLk2CQ8VK6"};
  var PLACE_LABEL={oyambre:"Oyambre",ramales:"Ramales",ruiloba:"Ruiloba",cardeo:"El Cardeo"};
  var WHATSAPP={oyambre:"34675696212",ramales:"34654463133",ruiloba:"34652806564",cardeo:"34664686158"};
  function i18nField(v){return typeof v==="string"?v:((v&&v[LANG])|| (v&&v.es) || "");}
  function waLink(camping,message){var n=WHATSAPP[String(camping||'').toLowerCase()]; return n?('https://wa.me/'+n+'?text='+encodeURIComponent(message||'')):null;}

  /* ===== Eventos (home + grid con filtros) ===== */
  var EVENTS=[], DATE_FILTER='all', CAMP_FILTER='all';
  function whenFmt(d){ try{ return new Intl.DateTimeFormat(LANG,{weekday:'short',day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}).format(new Date(d)); }catch(e){ return d; } }
  function categoryFor(dateStr){
    var d=new Date(dateStr), now=new Date();
    var startToday=new Date(now.getFullYear(),now.getMonth(),now.getDate());
    var startTomorrow=new Date(startToday); startTomorrow.setDate(startToday.getDate()+1);
    var endOfWeek=new Date(startToday); endOfWeek.setDate(startToday.getDate()+(7-startToday.getDay()));
    if(d>=startToday && d<startTomorrow) return 'today';
    if(d>=startTomorrow && d< new Date(startTomorrow.getFullYear(),startTomorrow.getMonth(),startTomorrow.getDate()+1)) return 'tomorrow';
    if(d>=startToday && d<endOfWeek) return 'week';
    return 'all';
  }

  function cardButtonsHTML(ev){
    var T=I18N[LANG];
    var rawTitle=i18nField(ev.titulo)||'(sin t√≠tulo)';
    var rawPlace=i18nField(ev.lugar)||PLACE_LABEL[String(ev.camping||'').toLowerCase()]||'';
    var wa=waLink(ev.camping,'Hola, consulta sobre ‚Äú'+rawTitle+'‚Äù en '+rawPlace+'.');
    return '<div class="row" style="margin-top:6px">'
      + '<button class="btn fav-btn" data-id="'+esc(ev.id||'')+'" data-start="'+esc(ev.fecha||'')+'">'+esc(T.fav)+'</button>'
      + '<button class="btn ics-btn" data-title="'+esc(rawTitle)+'" data-start="'+esc(ev.fecha||'')+'" data-loc="'+esc(rawPlace)+'">'+esc(T.addCal)+'</button>'
      + (wa?'<a class="btn" href="'+esc(wa)+'" target="_blank" rel="noopener">'+I18N[LANG].whatsapp+'</a>':'')
      + '<a class="btn" href="'+esc(PLACE_LINK[String(ev.camping||'').toLowerCase()]||'#')+'" target="_blank" rel="noopener">'+I18N[LANG].directions+'</a>'
      + '</div>';
  }

  function renderHomeSlider(){
    var wrap=$('#homeEvents'); if(!wrap) return;
    var next=EVENTS.slice().sort(function(a,b){return new Date(a.fecha)-new Date(b.fecha)}).slice(0,6);
    if(!next.length){ wrap.innerHTML='<div class="muted">Sin eventos por ahora.</div>'; return; }
    wrap.innerHTML = next.map(function(ev){
      var rawTitle=i18nField(ev.titulo)||'(sin t√≠tulo)';
      var rawPlace=i18nField(ev.lugar)||PLACE_LABEL[String(ev.camping||'').toLowerCase()]||'';
      var title=esc(rawTitle);
      var place=esc(rawPlace);
      var img=safeUrl(ev.imagen||ev.image||'');
      return '<div class="card event" data-id="'+esc(ev.id||'')+'" data-start="'+esc(ev.fecha||'')+'">'
        + (img?'<img src="'+img+'" alt="'+title+'" loading="lazy" onerror="this.style.display=\'none\'">':'')
        + '<div class="title">'+title+'</div>'
        + '<div class="meta">'+whenFmt(ev.fecha)+' ¬∑ '+place+'</div>'
        + cardButtonsHTML(ev)
        + '</div>';
    }).join('');
    enhanceEventCards();
  }

  function renderEventsGrid(){
    var grid=$('#eventsGrid'), empty=$('#eventsEmpty'); if(!grid) return;
    var filtered = EVENTS.filter(function(ev){
      var byDate = DATE_FILTER==='all' ? true : categoryFor(ev.fecha)===DATE_FILTER;
      var byCamp = CAMP_FILTER==='all' ? true : (String(ev.camping||'').toLowerCase()===CAMP_FILTER);
      return byDate && byCamp;
    }).sort(function(a,b){return new Date(a.fecha)-new Date(b.fecha)});
    if(!filtered.length){ grid.innerHTML=''; if(empty) empty.style.display='block'; return; }
    if(empty) empty.style.display='none';
    grid.innerHTML = filtered.map(function(ev){
      var rawTitle=i18nField(ev.titulo)||'(sin t√≠tulo)';
      var rawPlace=i18nField(ev.lugar)||PLACE_LABEL[String(ev.camping||'').toLowerCase()]||'';
      var title=esc(rawTitle);
      var place=esc(rawPlace);
      var img=safeUrl(ev.imagen||ev.image||'');
      return '<div class="card event" style="min-width:unset" data-id="'+esc(ev.id||'')+'" data-start="'+esc(ev.fecha||'')+'">'
        + (img?'<img src="'+img+'" alt="'+title+'" loading="lazy" onerror="this.style.display=\'none\'">':'')
        + '<div class="title">'+title+'</div>'
        + '<div class="meta">'+whenFmt(ev.fecha)+' ¬∑ '+place+'</div>'
        + cardButtonsHTML(ev)
        + '</div>';
    }).join('');
    enhanceEventCards();
  }

  function loadEvents(){
    fetch('./events.json?v='+(Date.now()),{cache:'no-store'})
      .then(function(r){return r.json();})
      .then(function(data){ EVENTS = Array.isArray(data)?data:[]; renderHomeSlider(); renderEventsGrid(); })
      .catch(function(){ EVENTS=[]; renderHomeSlider(); renderEventsGrid(); });
  }
  $all('[data-filter]').forEach(function(ch){
    on(ch,'click', function(){
      $all('[data-filter]').forEach(function(x){x.classList.remove('on');});
      ch.classList.add('on'); DATE_FILTER=ch.getAttribute('data-filter')||'all'; renderEventsGrid();
    });
  });
  $all('[data-camp]').forEach(function(ch){
    on(ch,'click', function(){
      $all('[data-camp]').forEach(function(x){x.classList.remove('on');});
      ch.classList.add('on'); CAMP_FILTER=ch.getAttribute('data-camp')||'all'; renderEventsGrid();
    });
  });

  /* ===== Horarios (schedules.json con fallback) ===== */
  var SCHEDULES_DEFAULT={
    oyambre:{es:"<b>Recepci√≥n</b>: 9:00‚Äì21:00<br><b>Restaurante</b>: 13:00‚Äì16:00 / 20:00‚Äì23:30<br><b>Piscina (verano)</b>: 10:00‚Äì20:00",
             en:"<b>Reception</b>: 9:00‚Äì21:00<br><b>Restaurant</b>: 13:00‚Äì16:00 / 20:00‚Äì23:30<br><b>Pool (summer)</b>: 10:00‚Äì20:00"},
    ramales:{es:"<b>Recepci√≥n</b>: 9:00‚Äì21:00<br><b>Bar</b>: 9:00‚Äì23:30<br><b>Piscina (verano)</b>: 11:00‚Äì20:00",
             en:"<b>Reception</b>: 9:00‚Äì21:00<br><b>Bar</b>: 9:00‚Äì23:30<br><b>Pool (summer)</b>: 11:00‚Äì20:00"},
    ruiloba:{es:"<b>Recepci√≥n</b>: 9:00‚Äì21:00<br><b>Restaurante</b>: 13:00‚Äì16:00 / 20:00‚Äì23:00",
             en:"<b>Reception</b>: 9:00‚Äì21:00<br><b>Restaurant</b>: 13:00‚Äì16:00 / 20:00‚Äì23:00"},
    cardeo:{es:"<b>Taberna</b>: 12:30‚Äì16:00 / 19:30‚Äì23:30<br><b>Apartamentos</b>: check-in 16:00, check-out 11:00",
            en:"<b>Tavern</b>: 12:30‚Äì16:00 / 19:30‚Äì23:30<br><b>Apartments</b>: check-in 16:00, check-out 11:00"}
  };
  var SCHEDULES = JSON.parse(JSON.stringify(SCHEDULES_DEFAULT));

  function renderAcc(){
    ['oyambre','ramales','ruiloba','cardeo'].forEach(function(k){
      var el=document.getElementById('acc-'+k);
      if(!el) return;
      var item=SCHEDULES[k]||SCHEDULES_DEFAULT[k]||{};
      el.innerHTML = item[LANG] || item.es || '';
    });
  }

  function loadSchedules(){
    fetch('./schedules.json?v='+(Date.now()),{cache:'no-store'})
      .then(function(r){ if(!r.ok) throw new Error('not ok'); return r.json(); })
      .then(function(json){
        if(json && typeof json==='object'){ SCHEDULES=json; renderAcc(); }
      })
      .catch(function(){ SCHEDULES=JSON.parse(JSON.stringify(SCHEDULES_DEFAULT)); renderAcc(); });
  }

  $all('.acc-h').forEach(function(h){
    on(h,'click', function(){ var item=h.parentElement; item.classList.toggle('open'); });
  });

  /* ===== Admin (tap x5 en logo + PIN) ===== */
  (function adminActivator(){
    var logo=document.getElementById('logoTap'); var taps=0,timer=null;
    if(!logo) return;

    function isAdminOn(){ return document.body.classList.contains('admin-on'); }
    function askForPin(){
      var stored = localStorage.getItem('admin_pin');
      if(!stored){ stored='311974'; localStorage.setItem('admin_pin', stored); }
      var entered = window.prompt('Introduce la contrase√±a de admin:','');
      if(entered===null) return false;
      if(entered===stored) return true;
      alert('Contrase√±a incorrecta');
      return false;
    }

    on(logo,'click', function(){
      taps++; clearTimeout(timer); timer=setTimeout(function(){taps=0},1000);
      if(taps>=5){
        taps=0;
        if(isAdminOn()){
          localStorage.setItem('admin','0');
          document.body.classList.remove('admin-on');
          alert('Modo admin desactivado');
        }else{
          if(!askForPin()) return;
          localStorage.setItem('admin','1');
          document.body.classList.add('admin-on');
          openAdminModal();
          loadEventsAdmin();
          loadSchedulesAdmin();
          alert('Modo admin activado');
        }
      }
    });

    localStorage.setItem('admin','0');
    document.body.classList.remove('admin-on');
  })();

  on($('#openAdmin'), 'click', function(){
    if(!document.body.classList.contains('admin-on')) return;
    openAdminModal();
    loadEventsAdmin();
    loadSchedulesAdmin();
  });

  function openAdminModal(){ var m=$('#adminModal'); if(m){ m.style.display='flex'; document.body.classList.add('modal-open'); } }
  function closeAdminModal(){ var m=$('#adminModal'); if(m){ m.style.display='none'; document.body.classList.remove('modal-open'); } }
  on($('#closeAdmin'),'click', function(e){ e.preventDefault(); closeAdminModal(); });
  on($('#adminModal'),'click', function(e){ if(e.target && e.target.id==='adminModal'){ closeAdminModal(); } });
  document.addEventListener('keydown', function(e){ if(e.key==='Escape'){ closeAdminModal(); } });

  /* ===== Admin tabla (filtro/orden) ===== */
  var ADMIN_EVENTS=[];
  var ADMIN_FILTER_CAMP='all';
  var ADMIN_SORT_ORDER='asc';

  function slug(s){return String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'').slice(0,60);}
  function isoFromLocal(dt){
    var d=new Date(dt);
    if(isNaN(d.getTime())) return dt;
    var tz=-d.getTimezoneOffset(), sign=tz>=0?'+':'-';
    function pad(n){return ('0'+n).slice(-2);}
    var yyyy=d.getFullYear(), mm=pad(d.getMonth()+1), dd=pad(d.getDate());
    var hh=pad(d.getHours()), mi=pad(d.getMinutes()), ss=pad(d.getSeconds());
    var oh=pad(Math.floor(Math.abs(tz)/60)), om=pad(Math.abs(tz)%60);
    return yyyy+'-'+mm+'-'+dd+'T'+hh+':'+mi+':'+ss+sign+oh+':'+om;
  }
  function defaultLugar(p){ if(p==='oyambre')return 'Camping Caravaning Playa de Oyambre'; if(p==='ramales')return 'Camping Ramales'; if(p==='ruiloba')return 'Camping El Helguero'; if(p==='cardeo')return 'Apartamentos El Cardeo'; return ''; }

  function loadEventsAdmin(){
    fetch('./events.json?v='+(Date.now()),{cache:'no-store'})
      .then(function(r){return r.json();})
      .then(function(data){ ADMIN_EVENTS = Array.isArray(data)?data:[]; renderAdminTable(); })
      .catch(function(){ ADMIN_EVENTS=[]; renderAdminTable(); });
    loadGhCfgToForm();
  }

  function renderAdminTable(){
    var tbody = $('#eventsTable tbody'); if(!tbody) return;
    var list = ADMIN_EVENTS.slice();

    if(ADMIN_FILTER_CAMP!=='all'){
      list = list.filter(function(e){ return String(e.camping||'').toLowerCase()===ADMIN_FILTER_CAMP; });
    }
    list.sort(function(a,b){
      var da=new Date(a.fecha).getTime(), db=new Date(b.fecha).getTime();
      return ADMIN_SORT_ORDER==='asc' ? (da-db) : (db-da);
    });

    tbody.innerHTML = list.map(function(ev){
      var titleES=(typeof ev.titulo==='string'?ev.titulo:((ev.titulo&&ev.titulo.es)||''))||'';
      var lugarES=(typeof ev.lugar==='string'?ev.lugar:((ev.lugar&&ev.lugar.es)||''))||'';
      var dt=new Date(ev.fecha);
      var val = dt.getFullYear()+'-'+('0'+(dt.getMonth()+1)).slice(-2)+'-'+('0'+dt.getDate()).slice(-2)+'T'+('0'+dt.getHours()).slice(-2)+':'+('0'+dt.getMinutes()).slice(-2);
      return '<tr data-id="'+ev.id+'">'
        + '<td class="muted">'+esc(ev.id)+'</td>'
        + '<td><input class="input dt" type="datetime-local" value="'+val+'"><div class="muted">'+esc(dt.toLocaleString())+'</div></td>'
        + '<td>'
          + '<select class="select camp">'
            + '<option value="oyambre" '+(ev.camping==='oyambre'?'selected':'')+'>oyambre</option>'
            + '<option value="ramales" '+(ev.camping==='ramales'?'selected':'')+'>ramales</option>'
            + '<option value="ruiloba" '+(ev.camping==='ruiloba'?'selected':'')+'>ruiloba</option>'
            + '<option value="cardeo" '+(ev.camping==='cardeo'?'selected':'')+'>cardeo</option>'
          + '</select>'
          + '<input class="input lugar" style="margin-top:6px" placeholder="Lugar (ES)" value="'+esc(lugarES)+'">'
        + '</td>'
        + '<td>'
          + '<input class="input titulo" placeholder="T√≠tulo (ES)" value="'+esc(titleES)+'">'
          + '<textarea class="textarea desc" rows="2" placeholder="Descripci√≥n (ES)" style="margin-top:6px">'+esc(((ev.descripcion&&ev.descripcion.es)||''))+'</textarea>'
          + '<input class="input img" placeholder="Imagen (URL)" value="'+esc((ev.imagen||ev.image||''))+'" style="margin-top:6px">'
        + '</td>'
        + '<td style="min-width:220px">'
          + '<button class="btn act-save">Guardar</button> '
          + '<button class="btn act-dup">Duplicar</button> '
          + '<button class="btn act-del">Borrar</button>'
        + '</td>'
      + '</tr>';
    }).join('');
    $all('#eventsTable tbody tr').forEach(function(tr){
      var id = tr.getAttribute('data-id');
      on(tr.querySelector('.act-save'),'click', function(){ saveRow(tr,id); });
      on(tr.querySelector('.act-dup'),'click', function(){ duplicateRow(id); });
      on(tr.querySelector('.act-del'),'click', function(){ deleteRow(id); });
    });
  }

  on($('#adminFilterCamp'),'change', function(e){ ADMIN_FILTER_CAMP=e.target.value||'all'; renderAdminTable(); });
  on($('#adminSortOrder'),'change', function(e){ ADMIN_SORT_ORDER=e.target.value||'asc'; renderAdminTable(); });

  function getRowValues(tr){
    return {dateLocal: tr.querySelector('.dt').value, camping: tr.querySelector('.camp').value,
      lugar: (tr.querySelector('.lugar').value||'').trim(), titulo: (tr.querySelector('.titulo').value||'').trim(),
      desc: (tr.querySelector('.desc').value||'').trim(), img: (tr.querySelector('.img').value||'').trim()};
  }
  function saveRow(tr,id){
    var v=getRowValues(tr); if(!v.titulo||!v.dateLocal||!v.camping){alert('Rellena t√≠tulo, fecha y alojamiento.');return;}
    var idx=ADMIN_EVENTS.findIndex(function(e){return e.id===id;}); if(idx<0) return;
    ADMIN_EVENTS[idx].fecha=isoFromLocal(v.dateLocal);
    ADMIN_EVENTS[idx].camping=v.camping;
    ADMIN_EVENTS[idx].titulo={es:v.titulo};
    ADMIN_EVENTS[idx].lugar={es:v.lugar||defaultLugar(v.camping)};
    ADMIN_EVENTS[idx].descripcion={es:v.desc||''};
    if(v.img) ADMIN_EVENTS[idx].imagen=v.img; else delete ADMIN_EVENTS[idx].imagen;
    renderAdminTable();
  }
  function duplicateRow(id){
    var o=ADMIN_EVENTS.find(function(e){return e.id===id;}); if(!o) return;
    var titleES=(o.titulo&&o.titulo.es)||''; var newId='ev-'+slug(titleES)+'-'+o.camping+'-'+Date.now().toString().slice(-8);
    var copy=JSON.parse(JSON.stringify(o)); copy.id=newId; ADMIN_EVENTS.push(copy); renderAdminTable();
  }
  function deleteRow(id){
    if(!confirm('¬øBorrar este evento?')) return;
    ADMIN_EVENTS = ADMIN_EVENTS.filter(function(e){return e.id!==id}); renderAdminTable();
  }

  on($('#addEventBtn'),'click', function(){
    var title=$('#evTitle').value.trim();
    var date=$('#evDate').value;
    var place=$('#evPlace').value;
    var lugar=$('#evLugar').value.trim() || defaultLugar(place);
    var img=$('#evImg').value.trim();
    var desc=$('#evDesc').value.trim();
    if(!title||!date||!place){alert('Rellena t√≠tulo, fecha y alojamiento.');return;}
    var id='ev-'+slug(title)+'-'+place+'-'+date.replace(/[:T]/g,'').slice(0,12);
    var obj={id:id,fecha:isoFromLocal(date),camping:place,titulo:{es:title},descripcion:{es:desc},lugar:{es:lugar}};
    if(img) obj.imagen=img;
    ADMIN_EVENTS.push(obj); renderAdminTable();
    ['#evTitle','#evDate','#evLugar','#evImg','#evDesc'].forEach(function(s){var el=$(s); if(el) el.value='';});
  });

  on($('#exportEventsBtn'),'click', function(){
    var blob=new Blob([JSON.stringify(ADMIN_EVENTS,null,2)],{type:'application/json'});
    var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='events.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  on($('#exportZipBtn'),'click', function(){
    try{
      var zip=new JSZip();
      zip.file('events.json', JSON.stringify(ADMIN_EVENTS,null,2));
      zip.file('schedules.json', JSON.stringify(SCHEDULES,null,2));
      var imgs=ADMIN_EVENTS.map(function(e){return e.imagen||e.image}).filter(Boolean);
      var folder=zip.folder('images'); var added={};
      Promise.all(imgs.map(function(u){
        if(added[u]) return Promise.resolve();
        return fetch(u,{mode:'cors'}).then(function(res){return res.blob()}).then(function(blob){return blob.arrayBuffer()}).then(function(buf){
          var name=(u.split('/').pop()||'image').split('?')[0]; folder.file(name,buf); added[u]=true;
        }).catch(function(){});
      })).then(function(){ return zip.generateAsync({type:'blob'}); }).then(function(blob){
        var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='backup_acobijo.zip'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });
    }catch(e){ alert('No se pudo generar la copia de seguridad.'); }
  });

  on($('#importFile'),'change', function(e){
    var f=e.target.files && e.target.files[0]; if(!f) return;
    f.text().then(function(txt){
      var data=JSON.parse(txt); if(!Array.isArray(data)) throw new Error('El JSON debe ser un array');
      ADMIN_EVENTS=data; renderAdminTable();
    }).catch(function(err){ alert('No se pudo leer el JSON: '+err.message); }).finally(function(){ e.target.value=''; });
  });

  /* ===== Schedules Admin ===== */
  function loadSchedulesAdmin(){
    var area=$('#schedJsonArea'); if(!area) return;
    try{ area.value=JSON.stringify(SCHEDULES,null,2); }catch(e){ area.value='{}'; }
  }
  on($('#schedApplyBtn'),'click', function(){
    var area=$('#schedJsonArea'); if(!area) return;
    try{
      var obj=JSON.parse(area.value);
      if(!obj || typeof obj!=='object') throw new Error('JSON inv√°lido');
      SCHEDULES=obj; renderAcc();
      alert('Horarios aplicados en la app.');
    }catch(err){ alert('No se pudo aplicar: '+err.message); }
  });
  on($('#exportSchedBtn'),'click', function(){
    var blob=new Blob([JSON.stringify(SCHEDULES,null,2)],{type:'application/json'});
    var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='schedules.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });
  on($('#importSchedFile'),'change', function(e){
    var f=e.target.files && e.target.files[0]; if(!f) return;
    f.text().then(function(txt){
      var data=JSON.parse(txt); if(!data || typeof data!=='object') throw new Error('JSON inv√°lido');
      SCHEDULES=data; renderAcc(); loadSchedulesAdmin();
    }).catch(function(err){ alert('No se pudo leer schedules.json: '+err.message); }).finally(function(){ e.target.value=''; });
  });

  /* ===== GitHub API (PAT) ===== */
  var GH_KEYS={repo:'ghRepo',branch:'ghBranch',token:'ghToken'};
  function loadGhCfgToForm(){
    var repoEl=$('#ghRepo'), branchEl=$('#ghBranch'), tokenEl=$('#ghToken');
    if(!repoEl||!branchEl||!tokenEl) return;
    repoEl.value=localStorage.getItem(GH_KEYS.repo)||'';
    branchEl.value=localStorage.getItem(GH_KEYS.branch)||'main';
    tokenEl.value=localStorage.getItem(GH_KEYS.token)||'';
  }
  function saveGhCfgFromForm(){
    var repoEl=$('#ghRepo'), branchEl=$('#ghBranch'), tokenEl=$('#ghToken');
    if(!repoEl||!branchEl||!tokenEl) return;
    localStorage.setItem(GH_KEYS.repo, (repoEl.value||'').trim());
    localStorage.setItem(GH_KEYS.branch, (branchEl.value||'').trim()||'main');
    var t=(tokenEl.value||'').trim(); if(t) localStorage.setItem(GH_KEYS.token, t);
    alert('Configuraci√≥n guardada en este dispositivo.');
  }
  function ghGet(path, token){
    var repo=localStorage.getItem(GH_KEYS.repo), branch=localStorage.getItem(GH_KEYS.branch)||'main';
    var url='https://api.github.com/repos/'+repo+'/contents/'+encodeURIComponent(path)+'?ref='+encodeURIComponent(branch);
    return fetch(url,{headers:{'Authorization':'token '+(token||'').trim(),'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28','User-Agent':'acobijo-app'}});
  }
  function ghPut(path, contentBase64, message, sha, token){
    var repo=localStorage.getItem(GH_KEYS.repo), branch=localStorage.getItem(GH_KEYS.branch)||'main';
    var url='https://api.github.com/repos/'+repo+'/contents/'+encodeURIComponent(path);
    var body={message:message,content:contentBase64,branch:branch}; if(sha) body.sha=sha;
    return fetch(url,{method:'PUT',headers:{'Authorization':'token '+(token||'').trim(),'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28','Content-Type':'application/json','User-Agent':'acobijo-app'},body:JSON.stringify(body)});
  }
  function toB64(str){ return btoa(unescape(encodeURIComponent(str))); }

  on($('#saveGhCfg'),'click', saveGhCfgFromForm);
  on($('#pushEventsBtn'),'click', saveEventsToGitHub);
  on($('#openAdmin'),'click', loadGhCfgToForm);

  function saveEventsToGitHub(){
    try{
      if(!ADMIN_EVENTS.length){ alert('No hay eventos en la lista. Primero a√±√°delos o importa JSON.'); return; }
      var token=(localStorage.getItem(GH_KEYS.token)||'').trim(); if(!token){alert('Configura el token en "Config GitHub".');return;}
      var sha=null;
      ghGet('events.json', token).then(function(res){
        if(res.status===200){ return res.json().then(function(data){ sha=data.sha; return 200; }); }
        if(res.status===404){ return 404; }
        return res.text().then(function(txt){ throw new Error('Error comprobando events.json: '+res.status+'\n'+txt); });
      }).then(function(){
        var jsonStr=JSON.stringify(ADMIN_EVENTS,null,2);
        var content64=toB64(jsonStr);
        var now=new Date().toISOString().slice(0,19).replace('T',' ');
        return ghPut('events.json',content64,'Update events.json via in-app admin ('+now+')',sha,token);
      }).then(function(res){
        if(res.ok){ alert('‚úÖ events.json subido correctamente.'); }
        else { return res.text().then(function(txt){ alert('‚ùå Error subiendo a GitHub: '+res.status+'\n'+txt); }); }
      }).catch(function(err){ alert('‚ùå Excepci√≥n subiendo a GitHub: '+err.message); });
    }catch(err){ alert('‚ùå Excepci√≥n subiendo a GitHub: '+err.message); }
  }

  function saveSchedulesToGitHub(){
    try{
      var token=(localStorage.getItem(GH_KEYS.token)||'').trim(); if(!token){alert('Configura el token en "Config GitHub".');return;}
      var sha=null;
      ghGet('schedules.json', token).then(function(res){
        if(res.status===200){ return res.json().then(function(data){ sha=data.sha; return 200; }); }
        if(res.status===404){ return 404; }
        return res.text().then(function(txt){ throw new Error('Error comprobando schedules.json: '+res.status+'\n'+txt); });
      }).then(function(){
        var jsonStr=JSON.stringify(SCHEDULES,null,2);
        var content64=toB64(jsonStr);
        var now=new Date().toISOString().slice(0,19).replace('T',' ');
        return ghPut('schedules.json',content64,'Update schedules.json via in-app admin ('+now+')',sha,token);
      }).then(function(res){
        if(res.ok){ alert('‚úÖ schedules.json subido correctamente.'); }
        else { return res.text().then(function(txt){ alert('‚ùå Error subiendo a GitHub: '+res.status+'\n'+txt); }); }
      }).catch(function(err){ alert('‚ùå Excepci√≥n subiendo a GitHub: '+err.message); });
    }catch(err){ alert('‚ùå Excepci√≥n subiendo a GitHub: '+err.message); }
  }
  on($('#pushSchedBtn'),'click', saveSchedulesToGitHub);

  /* ===== PWA install ===== */
  var deferredPrompt=null;
  window.addEventListener('beforeinstallprompt', function(e){ e.preventDefault(); deferredPrompt=e; });
  on($('#installTile'),'click', function(){
    if(deferredPrompt){ try{ deferredPrompt.prompt(); if(deferredPrompt.userChoice){ deferredPrompt.userChoice.then(function(){}); } }catch(e){} deferredPrompt=null; }
  });

  /* ===== Deep linking para shortcuts del manifest ===== */
  (function deepLinking(){
    try{
      const params = new URLSearchParams(location.search);
      const nav = params.get('nav');
      const focus = params.get('focus');
      if (nav) {
        const btn = document.querySelector('.navbtn[data-nav="'+nav+'"]') || document.querySelector('[data-nav="'+nav+'"]');
        if (btn) btn.click();
      }
      if (nav === 'places' && focus) {
        const mapIds = {oyambre:'t-oy-title', ramales:'t-ra-title', ruiloba:'t-he-title', cardeo:'t-ca-title'};
        const targetId = mapIds[String(focus).toLowerCase()];
        const el = targetId ? document.getElementById(targetId) : null;
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }catch(e){}
  })();

  /* ===== SW ===== */
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./service-worker.js');
    navigator.serviceWorker.addEventListener('message', (e) => {
      if (e.data && e.data.type === 'SW_ACTIVE') {
        console.log('PWA actualizada a', e.data.version);
      }
    });
  }

  /* ===== Guardar PIN admin ===== */
  on($('#saveAdminPin'),'click', function(){
    var v=($('#adminPinInput')||{}).value||'';
    if(!v || v.length<4){ alert('Introduce al menos 4 caracteres.'); return; }
    localStorage.setItem('admin_pin', v);
    alert('Contrase√±a guardada.');
  });

  /* ==========================
     üÜï FUNCIONES PRO CLIENTE
     ========================== */

  /* Config r√°pida */
  const CLIENTE_CFG = {
    wifi: { ssid: "GrupoACobijo", pass: "acobijo2025" },
    receptionHours: "09:00‚Äì21:00",
    contact: { whatsapp: "34675696212", email: "recepcion@grupoacobijo.es" },
    coords: { oyambre: { lat:43.392, lon:-4.364 } },
    pois: [
      { name:"Recepci√≥n Oyambre", lat:43.392, lon:-4.364, gmaps:"https://maps.google.com/?q=Camping+Caravaning+Playa+de+Oyambre" },
      { name:"Playa de Oyambre", lat:43.391, lon:-4.375, gmaps:"https://maps.google.com/?q=Playa+de+Oyambre" },
      { name:"El Cardeo", lat:43.386, lon:-4.402, gmaps:"https://maps.google.com/?q=El+Cardeo+San+Vicente+de+la+Barquera" }
    ]
  };

  /* Mi estancia */
  (function initStay(){
    var ss=$('#wifiSsid'), pw=$('#wifiPass'), rh=$('#recHours');
    if(ss) ss.textContent = CLIENTE_CFG.wifi.ssid;
    if(pw) pw.textContent = CLIENTE_CFG.wifi.pass;
    if(rh) rh.textContent = CLIENTE_CFG.receptionHours;
    on($('#copyWifi'),'click', async function(){
      try{ await navigator.clipboard.writeText(CLIENTE_CFG.wifi.pass); alert(I18N[LANG].copied); }catch(e){ alert('No se pudo copiar'); }
    });
  })();

  /* Clima (Open-Meteo) */
  async function loadWeather(){
    var card = $('#weatherCard'); if(!card) return;
    var lat=CLIENTE_CFG.coords.oyambre.lat, lon=CLIENTE_CFG.coords.oyambre.lon;
    var url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m&daily=temperature_2m_max,temperature_2m_min&timezone=Europe%2FMadrid`;
    try{
      var r=await fetch(url); var j=await r.json();
      var t=Math.round(j.current?.temperature_2m ?? 0);
      var w=Math.round(j.current?.wind_speed_10m ?? 0);
      var tmax=Math.round(j.daily?.temperature_2m_max?.[0] ?? 0);
      var tmin=Math.round(j.daily?.temperature_2m_min?.[0] ?? 0);
      card.innerHTML = '<div style="display:flex;align-items:center;justify-content:space-between;gap:12px">'
        + '<div><div style="font-size:28px;font-weight:700">'+t+'¬∞C</div>'
        + '<div class="small muted">Max '+tmax+'¬∞ ¬∑ Min '+tmin+'¬∞</div></div>'
        + '<div class="badge">Viento '+w+' km/h</div>'
        + '</div>';
    }catch(e){ card.innerHTML = '<div class="small muted">No se pudo cargar la previsi√≥n ahora mismo.</div>'; }
  }
  loadWeather();

  /* POIs & distancias */
  function haversineKm(a,b){const R=6371,toRad=x=>x*Math.PI/180;const dLat=toRad(b.lat-a.lat),dLon=toRad(b.lon-a.lon);
    const s1=Math.sin(dLat/2)**2+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLon/2)**2;return 2*R*Math.asin(Math.sqrt(s1));}
  async function renderPOIs(){
    var grid=$('#poisGrid'); if(!grid) return;
    grid.innerHTML='';
    let here=null;
    try{
      here = await new Promise((res,rej)=>{
        if(!navigator.geolocation) return rej();
        navigator.geolocation.getCurrentPosition(p=>res({lat:p.coords.latitude, lon:p.coords.longitude}), rej, {enableHighAccuracy:true, timeout:4000});
      });
    }catch(e){}
    CLIENTE_CFG.pois.forEach(function(p){
      const km = here ? haversineKm(here,p) : null;
      const mins = km ? Math.round((km*1000)/(1.4*60)) : null; // paseo ~1.4 m/s
      const card=document.createElement('div'); card.className='card'; card.style.minWidth='unset';
      card.innerHTML = '<div style="display:flex;align-items:center;justify-content:space-between;gap:8px">'
        + '<div><div style="font-weight:700">'+esc(p.name)+'</div>'
        + '<div class="muted">'+(km?km.toFixed(2)+' km ¬∑ ~'+mins+' min a pie':'Distancia no disponible')+'</div></div>'
        + '<a class="btn" target="_blank" rel="noopener" href="'+esc(p.gmaps)+'">C√≥mo llegar</a></div>';
      grid.appendChild(card);
    });
  }
  renderPOIs();

  /* Incidencias / Peticiones */
  function compressImage(file, maxW=1280, quality=0.7){
    return new Promise((resolve,reject)=>{
      const img=new Image(); const fr=new FileReader();
      fr.onload=()=>{ img.src=fr.result; }; fr.onerror=reject;
      img.onload=()=>{ const ratio=img.width>maxW?maxW/img.width:1; const w=Math.round(img.width*ratio),h=Math.round(img.height*ratio);
        const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
        c.toBlob(b=>resolve(b),'image/jpeg',quality); };
      if(file) fr.readAsDataURL(file); else resolve(null);
    });
  }
  async function buildIncidentText(){
    const t=($('#iTitle')||{}).value||''; const p=($('#iPlace')||{}).value||''; const d=($('#iDetail')||{}).value||'';
    let locTxt='';
    try{
      const pos = await new Promise((res,rej)=>{
        if(!navigator.geolocation) return rej();
        navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true, timeout:4000});
      });
      const {latitude,longitude}=pos.coords;
      locTxt = '\nUbicaci√≥n: https://maps.google.com/?q='+latitude+','+longitude;
    }catch(e){}
    return 'Incidencia/Petici√≥n'
      + '\nT√≠tulo: '+t
      + '\nUbicaci√≥n: '+p
      + '\nDetalle: '+d
      + locTxt;
  }
  on($('#sendWhats'),'click', async function(){
    const txt=await buildIncidentText();
    const num=CLIENTE_CFG.contact.whatsapp;
    const url='https://wa.me/'+num+'?text='+encodeURIComponent(txt);
    window.open(url,'_blank');
  });
  on($('#sendEmail'),'click', async function(){
    const txt=await buildIncidentText();
    const mail=CLIENTE_CFG.contact.email;
    const url='mailto:'+mail+'?subject='+encodeURIComponent('Incidencia/Petici√≥n')+'&body='+encodeURIComponent(txt);
    window.location.href=url;
  });
  on($('#copyTxt'),'click', async function(){
    const txt=await buildIncidentText();
    try{ await navigator.clipboard.writeText(txt); alert(I18N[LANG].copied); }catch(e){ alert('No se pudo copiar'); }
  });
  on($('#iPhoto'),'change', async function(e){
    const f=e.target.files && e.target.files[0]; if(!f) return;
    const b=await compressImage(f);
    if(!b){ alert('No se pudo procesar la imagen.'); return; }
    alert('Imagen optimizada. Adj√∫ntala desde tu galer√≠a al enviar por WhatsApp/Email.');
  });

  /* Eventos: Favoritos + Calendario (.ics) */
  function toICSTimestamp(d){ const pad=n=>String(n).padStart(2,'0');
    return d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())+'T'+pad(d.getUTCHours())+pad(d.getUTCMinutes())+pad(d.getUTCSeconds())+'Z'; }
  function icsFile(title, startISO, endISO, loc){
    const now=new Date();
    const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Grupo A Cobijo//ES',
      'BEGIN:VEVENT',
      'UID:'+crypto.randomUUID()+'@grupoacobijo',
      'DTSTAMP:'+toICSTimestamp(now),
      'DTSTART:'+toICSTimestamp(new Date(startISO)),
      'DTEND:'+toICSTimestamp(new Date(endISO)),
      'SUMMARY:'+String(title).replace(/,/g,'\\,').replace(/;/g,'\\;').replace(/\n/g,'\\n')];
    if(loc){ lines.push('LOCATION:'+String(loc).replace(/,/g,'\\,').replace(/;/g,'\\;').replace(/\n/g,'\\n')); }
    lines.push('END:VEVENT','END:VCALENDAR');
    return new Blob([lines.join('\r\n')], {type:'text/calendar'});
  }
  function enhanceEventCards(){
    const T=I18N[LANG]; const FKEY='favEvents';
    const favs=new Set(JSON.parse(localStorage.getItem(FKEY)||'[]'));

    function paint(btn,id){ btn.textContent = favs.has(id)?T.favOk:T.fav; }

    $all('.event .fav-btn').forEach(function(btn){
      const id=btn.getAttribute('data-id') || (btn.closest('.event')?.getAttribute('data-start')||'') ;
      if(!btn.dataset.wired){
        btn.dataset.wired='1';
        paint(btn,id);
        on(btn,'click', function(){
          if(favs.has(id)) favs.delete(id); else favs.add(id);
          localStorage.setItem(FKEY, JSON.stringify(Array.from(favs)));
          paint(btn,id);
        });
      }
    });

    $all('.event .ics-btn').forEach(function(btn){
      if(btn.dataset.wired) return;
      btn.dataset.wired='1';
      on(btn,'click', function(){
        const title=btn.getAttribute('data-title')||'Evento A Cobijo';
        const startISO=btn.getAttribute('data-start');
        const loc=btn.getAttribute('data-loc')||'';
        const start=new Date(startISO);
        const end=new Date(start.getTime()+60*60000); // 60 min por defecto
        const blob=icsFile(title,start.toISOString(),end.toISOString(),loc);
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=title+'.ics';
        document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
      });
    });
  }

  /* ===== Init ===== */
  applyLang();
  loadEvents();
  loadSchedules();
  renderAcc();

}); // DOMContentLoaded
</script>
</body>
</html>
